<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§é£²é£ŸåŠ©ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }



        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
            position: relative;
        }

        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            animation: titleGlow 3s ease-in-out infinite alternate;
        }

        @keyframes titleGlow {
            from { text-shadow: 0 2px 4px rgba(0,0,0,0.3), 0 0 20px rgba(255,255,255,0.1); }
            to { text-shadow: 0 2px 4px rgba(0,0,0,0.3), 0 0 30px rgba(255,255,255,0.3); }
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        /* AIåŠ©æ‰‹å°äººç‰© */
        .ai-assistant {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            animation: bounce 2s infinite;
            transition: transform 0.3s ease;
        }

        .ai-assistant:hover {
            transform: scale(1.1);
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        /* åŠ©æ‰‹å¯¹è¯æ°”æ³¡ */
        .assistant-bubble {
            position: fixed;
            bottom: 110px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 20px 20px 5px 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            max-width: 250px;
            z-index: 999;
            display: none;
            animation: fadeInUp 0.3s ease;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .assistant-bubble::after {
            content: '';
            position: absolute;
            bottom: -8px;
            right: 25px;
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid white;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 50px rgba(0,0,0,0.2);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb, #f5576c);
            background-size: 300% 100%;
            animation: gradientShift 3s ease infinite;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        @keyframes warningPulse {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.05); }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        .card h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* å¥åº·æé†’æ¨£å¼ */
        .health-alerts {
            border-left: 5px solid #ff6b6b;
            background: linear-gradient(135deg, #fff5f5 0%, #ffe8e8 100%);
        }

        .health-alerts h3 {
            color: #e74c3c;
        }

        .alert-item {
            padding: 12px 16px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            font-size: 14px;
            line-height: 1.5;
        }

        .alert-item.danger {
            background: linear-gradient(135deg, #fff5f5 0%, #ffe8e8 100%);
            border: 1px solid #ffcdd2;
            color: #c62828;
        }

        .alert-item.warning {
            background: linear-gradient(135deg, #fffbf0 0%, #fff4e0 100%);
            border: 1px solid #ffe0b2;
            color: #e65100;
        }

        .alert-icon {
            font-size: 18px;
            margin-top: 2px;
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .alert-description {
            font-size: 13px;
            opacity: 0.9;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:active {
            transform: translateY(-1px) scale(1.02);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #333;
            border: 2px solid #e1e5e9;
        }

        .btn-secondary:hover {
            background: #e1e5e9;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .nutrition-chart {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .nutrition-item {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .nutrition-item:hover {
            transform: scale(1.05);
        }

        .nutrition-item::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg);
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            50% { transform: translateX(100%) translateY(100%) rotate(45deg); }
            100% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
        }

        .nutrition-item .value {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .nutrition-item .label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .food-log {
            max-height: 300px;
            overflow-y: auto;
        }

        .food-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .food-item .info {
            flex: 1;
        }

        .food-item .name {
            font-weight: 600;
            color: #333;
        }

        .food-item .details {
            font-size: 0.9rem;
            color: #666;
            margin-top: 2px;
        }

        .food-item .calories {
            font-weight: bold;
            color: #667eea;
        }

        .chat-container {
            grid-column: span 3;
            max-height: 400px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            max-height: 300px;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 80%;
            line-height: 1.5;
        }

        .message.user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
        }

        .message.ai {
            background: #f8f9fa;
            color: #333;
            border: 1px solid #e1e5e9;
        }

        /* AIæ¶ˆæ¯ä¸­çš„è¡¨æ ¼æ ·å¼ */
        .message.ai table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 0.9rem;
        }

        .message.ai table th {
            background: #667eea;
            color: white;
            padding: 8px;
            text-align: center;
            font-weight: 600;
        }

        .message.ai table td {
            padding: 6px 8px;
            text-align: center;
            border: 1px solid #ddd;
        }

        .message.ai table tr:nth-child(even) {
            background: #f9f9f9;
        }

        .message.ai h3 {
            margin: 15px 0 8px 0;
            color: #667eea;
            font-size: 1.1rem;
        }

        .message.ai ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .message.ai li {
            margin: 5px 0;
            line-height: 1.4;
        }

        .message.ai p {
            margin: 10px 0;
            line-height: 1.6;
        }

        .message.ai strong {
            color: #667eea;
            font-weight: 600;
        }

        .message.ai h1, .message.ai h2, .message.ai h3 {
            margin: 15px 0 10px 0;
            color: #667eea;
        }

        .message.ai h1 {
            font-size: 1.3rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }

        .message.ai h2 {
            font-size: 1.2rem;
        }

        .message.ai h3 {
            font-size: 1.1rem;
        }

        /* æ–°å¢çš„æ™ºèƒ½æ ¼å¼åŒ–æ ·å¼ */
        .meal-section {
            margin: 20px 0;
            border-left: 4px solid #667eea;
            background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }

        .meal-title {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 16px;
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .meal-content {
            padding: 16px;
            line-height: 1.6;
        }

        .day-title {
            background: linear-gradient(135deg, #48cae4 0%, #0077b6 100%);
            color: white;
            padding: 10px 16px;
            margin: 15px 0 10px 0;
            border-radius: 8px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .highlight-tag {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 3px 8px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9rem;
            margin: 0 2px;
        }

        .nutrition-value {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.9rem;
            margin: 0 1px;
        }

        .emoji-highlight {
            font-size: 18px;
            margin: 0 4px;
            display: inline-block;
        }

        .food-separator {
            color: #667eea;
            font-weight: 600;
            margin: 0 4px;
        }

        .advice-list {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px 20px;
            margin: 15px 0;
            border-left: 4px solid #28a745;
        }

        .advice-item {
            margin: 8px 0;
            line-height: 1.5;
            color: #333;
        }

        .auto-paragraph {
            margin: 12px 0;
            line-height: 1.6;
            text-align: justify;
        }

        /* ä¸€é€±é£Ÿè­œè¦åŠƒæ¨£å¼ */
        .menu-settings-panel {
            margin-bottom: 30px;
            background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
            border: 2px solid #667eea;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .settings-grid .span-full {
            grid-column: 1 / -1;
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .weekly-menu-section {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%);
            border-radius: 20px;
            margin: 30px 0;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            border: 1px solid rgba(102, 126, 234, 0.2);
            overflow: hidden;
        }

        .section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .section-header h2 {
            font-size: 2rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .section-header p {
            font-size: 1.1rem;
            opacity: 0.9;
            margin: 0;
        }

        .weekly-menu-container {
            padding: 30px;
            min-height: 400px;
        }

        .menu-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-top: 15px;
        }

        .menu-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .menu-table th {
            padding: 15px 12px;
            text-align: center;
            font-weight: 600;
            font-size: 0.95rem;
            border-right: 2px solid rgba(255,255,255,0.3);
        }
        
        .menu-table th:first-child {
            border-right: 3px solid rgba(255,255,255,0.8);
        }
        
        .menu-table th:last-child {
            border-right: none;
        }

        .menu-table td {
            padding: 12px 8px;
            text-align: center;
            border-bottom: 1px solid #f0f0f0;
            border-right: 2px solid #e1e5e9;
            vertical-align: top;
            font-size: 0.85rem;
            line-height: 1.4;
        }
        
        /* å¢å¼·ä¸‰é¤åˆ†éš”ç·š */
        .menu-table td:not(.day-column) {
            border-left: 2px solid #d1d5db;
        }
        
        .menu-table td:last-child {
            border-right: none;
        }

        .menu-table tbody tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }
        
        /* é¤æ¬¡å…§å®¹hoveræ•ˆæœ */
        .meal-content:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color: rgba(102, 126, 234, 0.3);
            transform: translateY(-1px);
            transition: all 0.2s ease;
        }
        
        /* å¢å¼·è¡¨æ ¼æ•´é«”é‚Šæ¡† */
        .menu-table {
            border: 2px solid #667eea;
        }

        .day-column {
            font-weight: 600;
            color: #667eea;
            background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
            border-right: 3px solid #667eea !important;
        }

        .meal-content {
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 8px;
            border-radius: 6px;
            background: rgba(255,255,255,0.5);
            margin: 4px;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .meal-foods {
            color: #333;
            margin-bottom: 4px;
        }

        .meal-nutrition {
            color: #666;
            font-size: 0.75rem;
            font-style: italic;
        }

        .calories-row {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            font-weight: 600;
            border-top: 3px solid #667eea !important;
        }

        .calories-row td {
            border-bottom: none;
            border-right: none !important;
            border-left: none !important;
            padding: 10px 8px;
        }

        .empty-menu-table {
            text-align: center;
            padding: 40px 20px;
            color: #999;
            font-style: italic;
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 15px;
        }

        .menu-locked {
            position: relative;
        }

        .menu-locked::after {
            content: 'ğŸ”’';
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 18px;
            opacity: 0.7;
        }

        .generating-menu {
            text-align: center;
            padding: 40px 20px;
            color: #667eea;
        }

        .generating-menu .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-menu {
            text-align: center;
            padding: 40px 20px;
            color: #999;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .settings-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .button-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .section-header {
                padding: 20px;
            }
            
            .section-header h2 {
                font-size: 1.5rem;
            }
            
            .section-header p {
                font-size: 1rem;
            }
            
            .weekly-menu-container {
                padding: 15px;
            }
            
            .menu-table {
                font-size: 0.8rem;
            }
            
            .menu-table th,
            .menu-table td {
                padding: 8px 4px;
            }
            
            .menu-table th {
                font-size: 0.85rem;
            }
            
            .meal-foods {
                font-size: 0.75rem;
                line-height: 1.3;
            }
            
            .meal-nutrition {
                font-size: 0.7rem;
            }
            
            .day-column {
                font-size: 0.8rem;
            }
            
            .calories-row {
                font-size: 0.75rem;
            }
        }

        .chat-input {
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
        }

        .progress-ring {
            position: relative;
            width: 80px;
            height: 80px;
            margin: 0 auto 15px;
        }

        .progress-ring circle {
            fill: none;
            stroke-width: 8;
            stroke-linecap: round;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .progress-ring .bg {
            stroke: #e1e5e9;
        }

        .progress-ring .progress {
            stroke: #667eea;
            stroke-dasharray: 188.5;
            stroke-dashoffset: 188.5;
            transition: stroke-dashoffset 0.3s;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
            color: #667eea;
        }

        .recommendations {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            color: white;
        }

        .recommendations h4 {
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .recommendation-item {
            background: rgba(255,255,255,0.2);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            backdrop-filter: blur(10px);
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr 1fr;
            }
            .chat-container {
                grid-column: span 2;
            }
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            .chat-container {
                grid-column: span 1;
            }
            .nutrition-chart {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .icon {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }
    </style>
</head>
<body>
    <!-- AIåŠ©æ‰‹å°äººç‰© -->
    <div class="ai-assistant" onclick="toggleAssistantBubble()">ğŸ‘©â€âš•ï¸</div>
    <div class="assistant-bubble" id="assistantBubble">
        <strong>ğŸ¤– æˆ‘æ˜¯æ‚¨çš„AIç‡Ÿé¤Šå¸«ï¼</strong><br>
        <small>é»æ“Šæˆ‘å¯ä»¥ï¼š<br>
        â€¢ åˆ†ææ‚¨çš„é£²é£Ÿ<br>
        â€¢ æä¾›å¥åº·å»ºè­°<br>
        â€¢ æ¨è–¦ç‡Ÿé¤Šé£Ÿè­œ</small>
    </div>

    <div class="container">
        <div class="header">
            <h1>ğŸ¥— æ™ºæ…§é£²é£ŸåŠ©ç†</h1>
            <p>æ‚¨çš„å€‹äººåŒ–å¥åº·ç‡Ÿé¤Šé¡§å•</p>
            
            <!-- é é¢èª¿è©¦é¢æ¿ -->
            <div id="page-debug-panel" style="display: none; background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin: 10px 0; font-family: 'Courier New', monospace; font-size: 12px; max-height: 300px; overflow-y: auto; white-space: pre-wrap;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <strong>ğŸ” ç³»çµ±èª¿è©¦æ—¥èªŒ</strong>
                    <button onclick="clearPageLog()" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 10px; cursor: pointer;">
                        ğŸ—‘ï¸ æ¸…é™¤
                    </button>
                </div>
                <div id="page-debug-log"></div>
            </div>
            <div style="margin-bottom: 15px;">
                <button id="toggle-debug" onclick="togglePageDebug()" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 20px; font-size: 12px; cursor: pointer; margin-right: 10px;">
                    ğŸ“Š é¡¯ç¤º/éš±è—èª¿è©¦ä¿¡æ¯
                </button>
                <button onclick="testWebSocketConnection()" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 20px; font-size: 12px; cursor: pointer; margin-right: 5px;">
                    ğŸ”§ æ¸¬è©¦é€£æ¥
                </button>
                <button onclick="testMenuGeneration()" style="background: #17a2b8; color: white; border: none; padding: 8px 16px; border-radius: 20px; font-size: 12px; cursor: pointer; margin-right: 5px;">
                    ğŸ½ï¸ æ¸¬è©¦é£Ÿè­œ
                </button>
                <button onclick="showTableDemo()" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 20px; font-size: 12px; cursor: pointer; margin-right: 5px;">
                    ğŸ“‹ è¡¨æ ¼ç¤ºç¯„
                </button>
                <button onclick="debugMenuGeneration()" style="background: #ffc107; color: #212529; border: none; padding: 8px 16px; border-radius: 20px; font-size: 12px; cursor: pointer; margin-right: 10px;">
                    ğŸ” è¨ºæ–·å•é¡Œ
                </button>
                <small style="color: #666;">
                    â„¹ï¸ å¦‚æœç„¡æ³•é–‹å•Ÿç€è¦½å™¨æ§åˆ¶å°ï¼Œè«‹ä½¿ç”¨æ­¤é™¤éŒ¯é¢æ¿
                </small>
            </div>
        </div>

        <div class="main-grid">
            <!-- ä½¿ç”¨è€…è³‡è¨Šè¨­å®š -->
            <div class="card">
                <h3>
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                    å€‹äººè³‡è¨Š
                </h3>
                <div class="form-group">
                    <label for="age">å¹´é½¡</label>
                    <input type="number" id="age" placeholder="ä¾‹å¦‚: 25">
                </div>
                <div class="form-group">
                    <label for="height">èº«é«˜ (cm)</label>
                    <input type="number" id="height" placeholder="ä¾‹å¦‚: 170">
                </div>
                <div class="form-group">
                    <label for="weight">é«”é‡ (kg)</label>
                    <input type="number" id="weight" placeholder="ä¾‹å¦‚: 65">
                </div>
                <div class="form-group">
                    <label for="gender">æ€§åˆ¥</label>
                    <select id="gender">
                        <option value="">è«‹é¸æ“‡</option>
                        <option value="male">ç”·æ€§</option>
                        <option value="female">å¥³æ€§</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="activity">æ´»å‹•æ°´å¹³</label>
                    <select id="activity">
                        <option value="sedentary">ä¹…å (å¾ˆå°‘é‹å‹•)</option>
                        <option value="light">è¼•åº¦æ´»å‹• (æ¯é€±1-3æ¬¡é‹å‹•)</option>
                        <option value="moderate">ä¸­åº¦æ´»å‹• (æ¯é€±3-5æ¬¡é‹å‹•)</option>
                        <option value="high">é«˜åº¦æ´»å‹• (æ¯é€±6-7æ¬¡é‹å‹•)</option>
                        <option value="very_high">æ¥µé«˜æ´»å‹• (æ¯å¤©2æ¬¡é‹å‹•)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="medical-conditions">ç‰¹æ®Šç–¾ç—…</label>
                    <textarea id="medical-conditions" placeholder="å¦‚ï¼šç³–å°¿ç—…ã€é«˜è¡€å£“ã€å¿ƒè‡Ÿç—…ç­‰ï¼Œç„¡å‰‡ç•™ç©º" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label for="allergies">éæ•åŸ</label>
                    <textarea id="allergies" placeholder="å¦‚ï¼šèŠ±ç”Ÿã€æµ·é®®ã€ç‰›å¥¶ã€é›è›‹ç­‰ï¼Œç„¡å‰‡ç•™ç©º" rows="2"></textarea>
                </div>
                <button class="btn" onclick="saveUserProfile()">å„²å­˜è¨­å®š</button>
            </div>

            <!-- å¥åº·æé†’ -->
            <div class="card health-alerts" id="health-alerts" style="display: none;">
                <h3>
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                    å¥åº·æé†’
                </h3>
                <div id="health-alerts-content">
                    <!-- å‹•æ…‹ç”Ÿæˆçš„å¥åº·æé†’å…§å®¹ -->
                </div>
            </div>

            <!-- ä»Šæ—¥ç‡Ÿé¤Šæ”å– -->
            <div class="card">
                <h3>
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm2-7h-1V2h-2v2H8V2H6v2H5c-1.1 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z"/>
                    </svg>
                    ä»Šæ—¥ç‡Ÿé¤Šæ”å–
                </h3>
                <div class="progress-ring">
                    <svg width="80" height="80">
                        <circle class="bg" cx="40" cy="40" r="30"></circle>
                        <circle class="progress" cx="40" cy="40" r="30" id="calorie-progress"></circle>
                    </svg>
                    <div class="progress-text" id="calorie-text">0%</div>
                </div>
                <div class="nutrition-chart">
                    <div class="nutrition-item">
                        <div class="value" id="calories-consumed">0</div>
                        <div class="label">å¡è·¯é‡Œ</div>
                    </div>
                    <div class="nutrition-item">
                        <div class="value" id="protein-consumed">0g</div>
                        <div class="label">è›‹ç™½è³ª</div>
                    </div>
                    <div class="nutrition-item">
                        <div class="value" id="carbs-consumed">0g</div>
                        <div class="label">ç¢³æ°´åŒ–åˆç‰©</div>
                    </div>
                    <div class="nutrition-item">
                        <div class="value" id="fat-consumed">0g</div>
                        <div class="label">è„‚è‚ª</div>
                    </div>
                </div>
            </div>

            <!-- é£²é£Ÿè¨˜éŒ„ -->
            <div class="card">
                <h3>
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M11 9H9V2H7v7H5V2H3v7c0 2.12 1.66 3.84 3.75 3.97V22h2.5v-9.03C11.34 12.84 13 11.12 13 9V2h-2v7zm5-3v8h2.5v8H21V2c-2.76 0-5 2.24-5 4z"/>
                    </svg>
                    é£²é£Ÿè¨˜éŒ„
                </h3>
                <div class="form-group">
                    <label for="food-name">é£Ÿç‰©åç¨±</label>
                    <input type="text" id="food-name" placeholder="ä¾‹å¦‚: è˜‹æœ" autocomplete="off">
                    <div id="food-suggestions" style="display: none; position: absolute; background: white; border: 1px solid #ccc; border-radius: 4px; max-height: 200px; overflow-y: auto; z-index: 1000; width: calc(100% - 50px); box-shadow: 0 2px 8px rgba(0,0,0,0.1);"></div>
                </div>
                <div class="form-group">
                    <label for="food-amount">åˆ†é‡ (g)</label>
                    <input type="number" id="food-amount" placeholder="ä¾‹å¦‚: 100">
                </div>
                <button class="btn" onclick="addFood()">æ–°å¢é£Ÿç‰©</button>
                <button class="btn btn-secondary" onclick="clearTodayLog()">æ¸…ç©ºä»Šæ—¥è¨˜éŒ„</button>
                
                <div class="food-log" id="food-log">
                    <!-- é£Ÿç‰©è¨˜éŒ„å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                </div>
            </div>



            <!-- AIåŠ©ç†èŠå¤© -->
            <div class="card chat-container">
                <h3>
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h4l4 4 4-4h4c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
                    </svg>
                    AIé£²é£Ÿé¡§å•
                </h3>
                <div class="chat-messages" id="chat-messages">
                    <div class="message ai">
                        æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„æ™ºæ…§é£²é£ŸåŠ©ç†ã€‚æ‚¨å¯ä»¥å‘æˆ‘è«®è©¢ä»»ä½•é—œæ–¼ç‡Ÿé¤Šã€å¥åº·é£²é£Ÿçš„å•é¡Œã€‚æ¯”å¦‚ï¼š
                        <br>â€¢ "æˆ‘ä»Šå¤©çš„ç‡Ÿé¤Šæ”å–å¦‚ä½•ï¼Ÿ"
                        <br>â€¢ "æ¨è–¦ä¸€äº›æ¸›è„‚é£Ÿè­œ"
                        <br>â€¢ "ä»€éº¼é£Ÿç‰©å¯Œå«è›‹ç™½è³ªï¼Ÿ"
                    </div>
                </div>
                <div class="chat-input">
                    <input type="text" id="chat-input" placeholder="å‘AIåŠ©ç†æå•...">
                    <button class="btn" onclick="sendMessage()">å‚³é€</button>
                </div>
            </div>
        </div>

        <!-- ä¸€é€±é£Ÿè­œè¦åŠƒæ§åˆ¶é¢æ¿ -->
        <div class="card menu-settings-panel">
            <h3>
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm2-7h-1V2h-2v2H8V2H6v2H5c-1.1 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z"/>
                </svg>
                ğŸ“… ä¸€é€±é£Ÿè­œè¦åŠƒè¨­å®š
            </h3>
            <div class="settings-grid">
                <div class="form-group">
                    <label for="diet-goal">é£²é£Ÿç›®æ¨™</label>
                    <select id="diet-goal">
                        <option value="">è«‹é¸æ“‡æ‚¨çš„ç›®æ¨™</option>
                        <option value="weight-loss">æ¸›è„‚ç˜¦èº«</option>
                        <option value="weight-gain">å¢é‡å¢è‚Œ</option>
                        <option value="maintenance">ç¶­æŒé«”é‡</option>
                        <option value="muscle-gain">å¢è‚Œå¡‘å½¢</option>
                        <option value="health-recovery">ç–¾ç—…èª¿ç†</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="cuisine-preference">é£²é£Ÿåå¥½</label>
                    <select id="cuisine-preference">
                        <option value="balanced">å‡è¡¡é£²é£Ÿ</option>
                        <option value="chinese">ä¸­å¼æ–™ç†</option>
                        <option value="western">è¥¿å¼æ–™ç†</option>
                        <option value="vegetarian">ç´ é£Ÿä¸»ç¾©</option>
                        <option value="mediterranean">åœ°ä¸­æµ·é£²é£Ÿ</option>
                        <option value="ketogenic">ç”Ÿé…®é£²é£Ÿ</option>
                        <option value="low-carb">ä½ç¢³é£²é£Ÿ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="budget-range">é ç®—ç¯„åœ</label>
                    <select id="budget-range">
                        <option value="low">ç¶“æ¿Ÿå¯¦æƒ ï¼ˆæ¯æ—¥30-50å…ƒï¼‰</option>
                        <option value="medium">ä¸­ç­‰é ç®—ï¼ˆæ¯æ—¥50-100å…ƒï¼‰</option>
                        <option value="high">è¼ƒé«˜é ç®—ï¼ˆæ¯æ—¥100-200å…ƒï¼‰</option>
                        <option value="premium">ç²¾ç·»é£²é£Ÿï¼ˆæ¯æ—¥200å…ƒä»¥ä¸Šï¼‰</option>
                    </select>
                </div>
                <div class="form-group span-full">
                    <label for="dislike-foods">ä¸å–œæ­¡çš„é£Ÿç‰©</label>
                    <textarea id="dislike-foods" placeholder="ä¾‹å¦‚ï¼šè¾£æ¤’ã€æ´‹è”¥ã€ç´…è˜¿è””ç­‰ï¼Œç”¨é€—è™Ÿåˆ†éš”" rows="2"></textarea>
                </div>
            </div>
            <div class="button-group">
                <button class="btn" onclick="generateWeeklyMenu()" id="generate-menu-btn">ğŸ¯ ç”Ÿæˆå°ˆå±¬ä¸€é€±é£Ÿè­œ</button>
                <button class="btn btn-secondary" onclick="confirmClearMenu()" id="clear-menu-btn" style="display: none;">ğŸ—‘ï¸ åˆªé™¤ç›®å‰é£Ÿè­œ</button>
            </div>
        </div>

        <!-- ä¸€é€±é£Ÿè­œå±•ç¤ºå€åŸŸ -->
        <div class="weekly-menu-section">
            <div class="section-header">
                <h2>ğŸ½ï¸ æˆ‘çš„ä¸€é€±é£Ÿè­œ</h2>
                <p>æ ¹æ“šæ‚¨çš„å¥åº·ç‹€æ³å’Œé£²é£Ÿåå¥½ï¼Œç‚ºæ‚¨é‡èº«å®šè£½çš„å°ˆæ¥­ç‡Ÿé¤Šé£Ÿè­œ</p>
            </div>
            <div class="weekly-menu-container" id="weekly-menu-table">
                <div class="empty-menu-table">
                    ğŸ½ï¸ è«‹å…ˆåœ¨ä¸Šæ–¹è¨­å®šæ‚¨çš„é£²é£Ÿåå¥½ï¼Œç„¶å¾Œç”Ÿæˆå°ˆå±¬é£Ÿè­œ
                </div>
            </div>
        </div>

        <!-- å€‹äººåŒ–å»ºè­° -->
        <div class="card">
            <h3>
                <svg class="icon" viewBox="0 0 24 24">
                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
                å€‹äººåŒ–å¥åº·å»ºè­°
            </h3>
            <div class="recommendations" id="recommendations">
                <h4>ğŸ’¡ ä»Šæ—¥å»ºè­°</h4>
                <div class="recommendation-item">
                    æ­¡è¿ä½¿ç”¨æ™ºæ…§é£²é£ŸåŠ©ç†ï¼è«‹å…ˆå¡«å¯«æ‚¨çš„å€‹äººè³‡è¨Šä»¥ç²å¾—å€‹äººåŒ–å»ºè­°ã€‚
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let userProfile = {};
        let todayFood = [];
        let nutritionGoals = {};
        let weeklyMenu = null;

        // WebSocketè¿æ¥ - ä½¿ç”¨é ç¨‹æœå‹™
        const ws = new WebSocket(`wss://hshgpt.webduino.tw`);
        
        ws.onopen = () => {
            pageLog('âœ… [CONNECTION] WebSocketé€£æ¥å·²å»ºç«‹');
            updateConnectionStatus('connected');
        };
        
        ws.onerror = (error) => {
            pageLog('âŒ [CONNECTION] WebSocketé€£æ¥éŒ¯èª¤: ' + error);
            updateConnectionStatus('error');
        };
        
        ws.onclose = (event) => {
            pageLog(`ğŸ”´ [CONNECTION] WebSocketé€£æ¥å·²æ–·é–‹: ${event.code} ${event.reason}`);
            updateConnectionStatus('disconnected');
        };
        
        // ğŸ”— é€£æ¥ç‹€æ…‹æ›´æ–°å‡½æ•¸
        function updateConnectionStatus(status) {
            const generateBtn = document.getElementById('generate-menu-btn');
            
            if (status === 'connected') {
                generateBtn.style.opacity = '1';
                generateBtn.title = 'é€£æ¥æ­£å¸¸ï¼Œå¯ä»¥ç”Ÿæˆé£Ÿè­œ';
            } else if (status === 'error' || status === 'disconnected') {
                generateBtn.style.opacity = '0.5';
                generateBtn.title = 'WebSocketé€£æ¥ç•°å¸¸ï¼Œè«‹åˆ·æ–°é é¢é‡è©¦';
                
                // å¦‚æœæ­£åœ¨ç”Ÿæˆé£Ÿè­œæ™‚æ–·ç·šï¼Œé¡¯ç¤ºéŒ¯èª¤
                if (isGeneratingMenu) {
                    isGeneratingMenu = false;
                    document.getElementById('weekly-menu-table').innerHTML = `
                        <div class="empty-menu-table">
                            ğŸ”´ é€£æ¥ä¸­æ–·<br>
                            <small style="color: #666; margin-top: 8px; display: block;">
                                WebSocketé€£æ¥å·²æ–·é–‹ï¼Œè«‹åˆ·æ–°é é¢é‡è©¦
                            </small>
                        </div>
                    `;
                    resetMenuButtons();
                }
            }
        }

        // å­˜å„²é£Ÿè­œç”Ÿæˆçš„æ–‡æœ¬
        let currentMenuText = '';
        let isGeneratingMenu = false;
        
        // ğŸ“Š é é¢èª¿è©¦ç³»çµ±
        function togglePageDebug() {
            const panel = document.getElementById('page-debug-panel');
            const isVisible = panel.style.display !== 'none';
            panel.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                pageLog('ğŸ“Š èª¿è©¦é¢æ¿å·²é–‹å•Ÿ');
                pageLog('â„¹ï¸ æ‰€æœ‰ç³»çµ±æ—¥èªŒå°‡åœ¨æ­¤é¡¯ç¤º');
            }
        }
        
        function pageLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('page-debug-log');
            if (logDiv) {
                logDiv.textContent += `[${timestamp}] ${message}\n`;
                logDiv.scrollTop = logDiv.scrollHeight;
            }
            // åŒæ™‚è¼¸å‡ºåˆ°æ§åˆ¶å°ï¼ˆå¦‚æœèƒ½é–‹å•Ÿçš„è©±ï¼‰
            console.log(message);
        }
        
        function clearPageLog() {
            const logDiv = document.getElementById('page-debug-log');
            if (logDiv) {
                logDiv.textContent = '';
            }
        }
        
        // ğŸ”§ æ¸¬è©¦WebSocketé€£æ¥
        function testWebSocketConnection() {
            pageLog('ğŸ”§ [TEST] é–‹å§‹æ¸¬è©¦WebSocketé€£æ¥...');
            pageLog('ğŸ“Š [TEST] é€£æ¥ç‹€æ…‹: ' + ws.readyState + ' (0=CONNECTING, 1=OPEN, 2=CLOSING, 3=CLOSED)');
            
            if (ws.readyState === WebSocket.OPEN) {
                pageLog('âœ… [TEST] WebSocketé€£æ¥æ­£å¸¸ï¼Œç™¼é€æ¸¬è©¦æ¶ˆæ¯...');
                
                // ç™¼é€ä¸€å€‹ç°¡å–®çš„æ¸¬è©¦è«‹æ±‚
                const testPrompt = 'è«‹ç°¡å–®å›ç­”ï¼šä½ å¥½å—ï¼Ÿ';
                ws.send(JSON.stringify({ 
                    prompt: testPrompt, 
                    requestType: 'chat'
                }));
                
                pageLog('ğŸ“¤ [TEST] æ¸¬è©¦æ¶ˆæ¯å·²ç™¼é€ï¼Œç­‰å¾…å›æ‡‰...');
                
                // è¨­ç½®æ¸¬è©¦è¶…æ™‚
                setTimeout(() => {
                    pageLog('â° [TEST] æ¸¬è©¦çµæŸï¼ˆ10ç§’ï¼‰');
                }, 10000);
                
            } else {
                pageLog('âŒ [TEST] WebSocketé€£æ¥ç•°å¸¸ï¼Œå˜—è©¦é‡æ–°é€£æ¥...');
                pageLog('ğŸ’¡ [TEST] å»ºè­°åˆ·æ–°é é¢é‡æ–°å»ºç«‹é€£æ¥');
            }
        }
        
        // ğŸ½ï¸ æ¸¬è©¦é£Ÿè­œç”Ÿæˆ
        function testMenuGeneration() {
            pageLog('ğŸ½ï¸ [MENU-TEST] é–‹å§‹æ¸¬è©¦é£Ÿè­œç”Ÿæˆ...');
            
            if (ws.readyState !== WebSocket.OPEN) {
                pageLog('âŒ [MENU-TEST] WebSocketé€£æ¥ç•°å¸¸ï¼Œç„¡æ³•æ¸¬è©¦');
                return;
            }
            
            // è¨­ç½®æ¸¬è©¦ç‹€æ…‹
            isGeneratingMenu = true;
            currentMenuText = '';
            
            pageLog('ğŸ”§ [MENU-TEST] è¨­ç½®æ¸¬è©¦æ¨¡å¼ï¼ŒisGeneratingMenu = true');
            
            // ç™¼é€ç°¡åŒ–çš„é£Ÿè­œæ¸¬è©¦è«‹æ±‚ï¼Œä½¿ç”¨ç¹é«”ä¸­æ–‡
            const testPrompt = `ã€é‡è¦ã€‘è«‹ä½¿ç”¨ç¹é«”ä¸­æ–‡å›ç­”ï¼Œä¸¦ä½¿ç”¨å°ç£çš„é£Ÿç‰©ç”¨è©ã€‚

è«‹ç”Ÿæˆä¸€é€±çš„ç°¡å–®é£Ÿè­œï¼ŒåŒ…å«æ—©é¤ã€åˆé¤ã€æ™šé¤ã€‚

æ ¼å¼è¦æ±‚ï¼š
é€±ä¸€ ç¸½è¨ˆç´„1800å¡
æ—©é¤ï¼šç‡•éº¥ç²¥ + æ°´ç…®è›‹ + ç‰›å¥¶ (ç´„400å¡)
åˆé¤ï¼šé›èƒ¸è‚‰æ²™æ‹‰ + å…¨éº¥éºµåŒ… (ç´„700å¡)
æ™šé¤ï¼šæ¸…è’¸é­š + è’¸è›‹ + é’èœ (ç´„500å¡)

è«‹æä¾›å®Œæ•´çš„ä¸€é€±é£Ÿè­œã€‚`;
            
            const testRequest = {
                prompt: testPrompt,
                requestType: 'weekly-menu'
            };
            
            pageLog('ğŸ“¤ [MENU-TEST] ç™¼é€æ¸¬è©¦è«‹æ±‚: ' + JSON.stringify(testRequest));
            
            ws.send(JSON.stringify(testRequest));
            
            // æ¸¬è©¦è¶…æ™‚
            setTimeout(() => {
                if (isGeneratingMenu) {
                    pageLog('â° [MENU-TEST] æ¸¬è©¦è¶…æ™‚ï¼ˆ30ç§’ï¼‰ï¼Œé‡ç½®ç‹€æ…‹');
                    isGeneratingMenu = false;
                    currentMenuText = '';
                } else {
                    pageLog('âœ… [MENU-TEST] æ¸¬è©¦å·²å®Œæˆ');
                }
            }, 30000);
        }
         
         // ğŸ“‹ é¡¯ç¤ºè¡¨æ ¼ç¤ºç¯„
         function showTableDemo() {
             pageLog('ğŸ“‹ [DEMO] é¡¯ç¤ºè¡¨æ ¼æ ¼å¼ç¤ºç¯„');
             
             const demoMenuText = `é€±ä¸€ ç¸½è¨ˆç´„1980å¡
ğŸ½ï¸ æ—©é¤ï¼šç‡•éº¥ç²¥ + ç„¡ç³–è±†æ¼¿ + æ°´ç…®è›‹ + å¥‡ç•°æœ (å…±ç´„420å¡ï¼Œè›‹ç™½è³ª20g)
ğŸ½ï¸ åˆé¤ï¼šè’¸é›èƒ¸è‚‰ + é›œç³§é£¯ + æ¶¼æ‹Œå°é»ƒç“œ + å‘³å™Œæ¹¯ (å…±ç´„620å¡ï¼Œè›‹ç™½è³ª38g)
ğŸ½ï¸ æ™šé¤ï¼šæ¸…è’¸é¯›é­š + è’¸è›‹ + ç‚’é’æ±Ÿèœ + å°ä»½é¦¬éˆ´è–¯æ³¥ (å…±ç´„540å¡ï¼Œè›‹ç™½è³ª25g)

é€±äºŒ ç¸½è¨ˆç´„1950å¡
ğŸ½ï¸ æ—©é¤ï¼šå…¨éº¥åå¸ + ç„¡ç³–ä½è„‚å„ªæ ¼ + æ°´ç…®è›‹ + è˜‹æœåŠé¡† (ç´„430å¡ï¼Œè›‹ç™½è³ª22g)
ğŸ½ï¸ åˆé¤ï¼šç‚’ç‰›è‚‰ç‰‡ + ç³™ç±³é£¯ + ç‚’å››å­£è±† + ç´«èœæ¹¯ (ç´„680å¡ï¼Œè›‹ç™½è³ª40g)
ğŸ½ï¸ æ™šé¤ï¼šé‚Šè¦ä» + è’¸çµ²ç“œ + ç³™ç±³é£¯ + ç´«èœç´…è±†æ¹¯ (ç´„540å¡ï¼Œè›‹ç™½è³ª25g)

é€±ä¸‰ ç¸½è¨ˆç´„1900å¡
ğŸ½ï¸ æ—©é¤ï¼šåœ°ç“œ + è’¸è›‹ + ç„¡ç³–è±†æ¼¿ + å°ç•ªèŒ„ (ç´„400å¡ï¼Œè›‹ç™½è³ª18g)
ğŸ½ï¸ åˆé¤ï¼šçƒ¤é®­é­š + äº”ç©€é£¯ + ç‚’é«˜éº—èœ + æµ·å¸¶æ¹¯ (ç´„650å¡ï¼Œè›‹ç™½è³ª35g)
ğŸ½ï¸ æ™šé¤ï¼šè’¸é›è…¿è‚‰ + ç‚’é’èŠ±èœ + ç³™ç±³ç²¥ + è›¤èœŠæ¹¯ (ç´„500å¡ï¼Œè›‹ç™½è³ª28g)`;
             
             // å¼·åˆ¶ä½¿ç”¨è¡¨æ ¼æ ¼å¼é¡¯ç¤º
             const tableHtml = forceTableGeneration(demoMenuText);
             
             // é¡¯ç¤ºåœ¨é£Ÿè­œå€åŸŸ
             const weeklyMenuDiv = document.getElementById('weekly-menu-table');
             weeklyMenuDiv.innerHTML = tableHtml;
             
             // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
             document.getElementById('generate-menu-btn').style.display = 'none';
             document.getElementById('clear-menu-btn').style.display = 'inline-block';
             
             pageLog('âœ… [DEMO] è¡¨æ ¼ç¤ºç¯„å·²é¡¯ç¤º');
         }
         
         // ğŸ” è¨ºæ–·é£Ÿè­œç”Ÿæˆå•é¡Œ
         function debugMenuGeneration() {
             pageLog('ğŸ” [DIAGNOSIS] ===== é–‹å§‹è¨ºæ–·é£Ÿè­œç”Ÿæˆå•é¡Œ =====');
             
             // æª¢æŸ¥1: ç•Œé¢å…ƒç´ 
             pageLog('ğŸ“‹ [DIAGNOSIS] æ­¥é©Ÿ1: æª¢æŸ¥ç•Œé¢å…ƒç´ ');
             const dietGoal = document.getElementById('diet-goal');
             const cuisinePreference = document.getElementById('cuisine-preference');
             const dislikeFoods = document.getElementById('dislike-foods');
             const budgetRange = document.getElementById('budget-range');
             
             pageLog('ğŸ“Š [DIAGNOSIS] é£²é£Ÿç›®æ¨™å…ƒç´ : ' + (dietGoal ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'));
             pageLog('ğŸ½ï¸ [DIAGNOSIS] é£²é£Ÿåå¥½å…ƒç´ : ' + (cuisinePreference ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'));
             pageLog('ğŸš« [DIAGNOSIS] ä¸å–œæ­¡é£Ÿç‰©å…ƒç´ : ' + (dislikeFoods ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'));
             pageLog('ğŸ’° [DIAGNOSIS] é ç®—ç¯„åœå…ƒç´ : ' + (budgetRange ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'));
             
             if (dietGoal) pageLog('ğŸ“Š [DIAGNOSIS] é£²é£Ÿç›®æ¨™å€¼: ' + dietGoal.value);
             if (cuisinePreference) pageLog('ğŸ½ï¸ [DIAGNOSIS] é£²é£Ÿåå¥½å€¼: ' + cuisinePreference.value);
             if (dislikeFoods) pageLog('ğŸš« [DIAGNOSIS] ä¸å–œæ­¡é£Ÿç‰©å€¼: ' + dislikeFoods.value);
             if (budgetRange) pageLog('ğŸ’° [DIAGNOSIS] é ç®—ç¯„åœå€¼: ' + budgetRange.value);
             
             // æª¢æŸ¥2: ç¾æœ‰é£Ÿè­œ
             pageLog('ğŸ“‹ [DIAGNOSIS] æ­¥é©Ÿ2: æª¢æŸ¥ç¾æœ‰é£Ÿè­œ');
             pageLog('ğŸ½ï¸ [DIAGNOSIS] weeklyMenuç‹€æ…‹: ' + (weeklyMenu ? 'å­˜åœ¨' : 'ç„¡'));
             if (weeklyMenu) {
                 pageLog('ğŸ“„ [DIAGNOSIS] weeklyMenuå…§å®¹: ' + (weeklyMenu.content ? 'æœ‰å…§å®¹' : 'ç„¡å…§å®¹'));
             }
             
             // æª¢æŸ¥3: ç”¨æˆ¶è³‡æ–™
             pageLog('ğŸ“‹ [DIAGNOSIS] æ­¥é©Ÿ3: æª¢æŸ¥ç”¨æˆ¶è³‡æ–™');
             pageLog('ğŸ‘¤ [DIAGNOSIS] userProfile: ' + JSON.stringify(userProfile));
             const requiredFields = ['age', 'height', 'weight', 'gender', 'activity'];
             const missingFields = requiredFields.filter(field => !userProfile[field]);
             pageLog('âŒ [DIAGNOSIS] ç¼ºå°‘çš„å¿…å¡«å­—æ®µ: ' + (missingFields.length > 0 ? missingFields.join(', ') : 'ç„¡'));
             
             // æª¢æŸ¥4: ç‡Ÿé¤Šç›®æ¨™
             pageLog('ğŸ“‹ [DIAGNOSIS] æ­¥é©Ÿ4: æª¢æŸ¥ç‡Ÿé¤Šç›®æ¨™');
             pageLog('ğŸ¯ [DIAGNOSIS] nutritionGoals: ' + JSON.stringify(nutritionGoals));
             pageLog('ğŸ“Š [DIAGNOSIS] ç‡Ÿé¤Šç›®æ¨™calories: ' + (nutritionGoals?.calories || 'æœªè¨­ç½®'));
             
             // æª¢æŸ¥5: WebSocketç‹€æ…‹
             pageLog('ğŸ“‹ [DIAGNOSIS] æ­¥é©Ÿ5: æª¢æŸ¥WebSocketç‹€æ…‹');
             pageLog('ğŸ”— [DIAGNOSIS] WebSocketç‹€æ…‹: ' + ws.readyState + ' (1=æ­£å¸¸)');
             
             // æª¢æŸ¥6: ç”Ÿæˆç‹€æ…‹
             pageLog('ğŸ“‹ [DIAGNOSIS] æ­¥é©Ÿ6: æª¢æŸ¥ç”Ÿæˆç‹€æ…‹');
             pageLog('âš™ï¸ [DIAGNOSIS] isGeneratingMenu: ' + isGeneratingMenu);
             
             // ç¸½çµè¨ºæ–·çµæœ
             pageLog('ğŸ“‹ [DIAGNOSIS] ===== è¨ºæ–·ç¸½çµ =====');
             
             let issueCount = 0;
             
             if (!dietGoal?.value) {
                 pageLog('âŒ [DIAGNOSIS] å•é¡Œ1: é£²é£Ÿç›®æ¨™æœªè¨­ç½®');
                 issueCount++;
             }
             
             if (weeklyMenu && weeklyMenu.content) {
                 pageLog('âŒ [DIAGNOSIS] å•é¡Œ2: å·²æœ‰é£Ÿè­œå­˜åœ¨ï¼Œéœ€å…ˆåˆªé™¤');
                 issueCount++;
             }
             
             if (missingFields.length > 0) {
                 pageLog('âŒ [DIAGNOSIS] å•é¡Œ3: ç”¨æˆ¶è³‡æ–™ä¸å®Œæ•´ - ' + missingFields.join(', '));
                 issueCount++;
             }
             
             if (!nutritionGoals?.calories) {
                 pageLog('âŒ [DIAGNOSIS] å•é¡Œ4: ç‡Ÿé¤Šç›®æ¨™æœªè¨ˆç®—');
                 issueCount++;
             }
             
             if (ws.readyState !== 1) {
                 pageLog('âŒ [DIAGNOSIS] å•é¡Œ5: WebSocketé€£æ¥ç•°å¸¸');
                 issueCount++;
             }
             
             if (isGeneratingMenu) {
                 pageLog('âŒ [DIAGNOSIS] å•é¡Œ6: æ­£åœ¨ç”Ÿæˆä¸­ï¼Œè«‹ç­‰å¾…å®Œæˆ');
                 issueCount++;
             }
             
             if (issueCount === 0) {
                 pageLog('âœ… [DIAGNOSIS] æœªç™¼ç¾å•é¡Œï¼Œé£Ÿè­œç”Ÿæˆæ‡‰è©²èƒ½æ­£å¸¸å·¥ä½œ');
                 pageLog('ğŸ’¡ [DIAGNOSIS] å»ºè­°: å˜—è©¦ç›´æ¥é»æ“Š"ç”Ÿæˆå°ˆå±¬ä¸€é€±é£Ÿè­œ"æŒ‰éˆ•');
             } else {
                 pageLog('ğŸ”§ [DIAGNOSIS] ç™¼ç¾ ' + issueCount + ' å€‹å•é¡Œï¼Œè«‹æ ¹æ“šä¸Šè¿°æç¤ºè§£æ±º');
             }
             
             pageLog('ğŸ” [DIAGNOSIS] ===== è¨ºæ–·å®Œæˆ =====');
         }
 
          ws.onmessage = (event) => {
            // ğŸ“¨ è¨˜éŒ„æ‰€æœ‰æ”¶åˆ°çš„åŸå§‹æ¶ˆæ¯
            pageLog('ğŸ“¨ [RAW] æ”¶åˆ°WebSocketåŸå§‹æ¶ˆæ¯: ' + event.data.substring(0, 200) + '...');
            
            const data = JSON.parse(event.data);
            
            pageLog('ğŸ“¨ [DEBUG] è§£æå¾Œçš„æ¶ˆæ¯: type=' + data.type + ', requestType=' + data.requestType + ', isGeneratingMenu=' + isGeneratingMenu);
            
            if (data.delta) {
                pageLog('ğŸ“ [DEBUG] æ¶ˆæ¯å…§å®¹é è¦½: ' + data.delta.substring(0, 100) + '...');
            }
            
            // ğŸ” æª¢æŸ¥æ˜¯å¦ç¼ºå°‘requestTypeï¼ˆå¯èƒ½æ˜¯å•é¡Œæ ¹æºï¼‰
            if (!data.requestType) {
                pageLog('âš ï¸ [WARNING] æ¶ˆæ¯ç¼ºå°‘requestTypeå­—æ®µ');
                
                // ğŸ”§ å‚™ç”¨è­˜åˆ¥æ©Ÿåˆ¶ï¼šå¦‚æœæ­£åœ¨ç”Ÿæˆé£Ÿè­œä¸”æ”¶åˆ°æ¶ˆæ¯ï¼Œè¦–ç‚ºé£Ÿè­œå›æ‡‰
                if (isGeneratingMenu) {
                    pageLog('ğŸ”§ [FALLBACK] æ­£åœ¨ç”Ÿæˆé£Ÿè­œæœŸé–“æ”¶åˆ°æ¶ˆæ¯ï¼Œè¦–ç‚ºé£Ÿè­œå›æ‡‰');
                    data.requestType = 'weekly-menu'; // æ‰‹å‹•è¨­ç½®requestType
                } else {
                    pageLog('ğŸ“ [FALLBACK] éé£Ÿè­œç”ŸæˆæœŸé–“ï¼Œè¦–ç‚ºèŠå¤©æ¶ˆæ¯');
                }
            }
            
            // ğŸ›¡ï¸ è¶…ç´šä¿è­·ï¼šå¦‚æœæ˜¯é£Ÿè­œç”Ÿæˆè«‹æ±‚ï¼Œçµ•å°ä¸èƒ½é€²å…¥èŠå¤©è™•ç†
            if (data.requestType === 'weekly-menu') {
                pageLog('ğŸ½ï¸ [MENU] é£Ÿè­œç”Ÿæˆæ¨¡å¼ - å®Œå…¨éš”é›¢èŠå¤©æ¨¡çµ„: ' + data.type);
                
                if (data.type === 'start') {
                    isGeneratingMenu = true;
                    currentMenuText = '';
                    pageLog('ğŸ¯ [MENU] é–‹å§‹ç”Ÿæˆé£Ÿè­œï¼Œè¨­ç½®éš”é›¢ç‹€æ…‹');
                } else if (data.type === 'chunk') {
                    let cleanText = data.delta;
                    // éæ¿¾èª¿è©¦è¨Šæ¯
                    if (!cleanText.includes('æ­£åœ¨å‚³é€ prompt') && 
                        !cleanText.includes('Azure OpenAI å›æ‡‰') && 
                        !cleanText.includes('--- å›æ‡‰çµæŸ ---') &&
                        !cleanText.includes('>>>>>')) {
                        currentMenuText += cleanText;
                        pageLog('ğŸ“ [MENU] ç´¯ç©é£Ÿè­œå…§å®¹ï¼Œé•·åº¦: ' + currentMenuText.length);
                    } else {
                        pageLog('ğŸš« [MENU] éæ¿¾èª¿è©¦è¨Šæ¯: ' + cleanText.substring(0, 50));
                    }
                } else if (data.type === 'end') {
                    isGeneratingMenu = false;
                    pageLog('âœ… [MENU] é£Ÿè­œç”Ÿæˆå®Œæˆï¼Œç¸½é•·åº¦: ' + currentMenuText.length);
                    pageLog('ğŸ“„ [MENU] æº–å‚™é¡¯ç¤ºé£Ÿè­œå…§å®¹');
                    
                    if (currentMenuText.trim().length > 0) {
                        handleWeeklyMenuResponse(currentMenuText);
                    } else {
                        pageLog('âŒ [MENU] é£Ÿè­œå…§å®¹ç‚ºç©ºï¼');
                        document.getElementById('weekly-menu-table').innerHTML = `
                            <div class="empty-menu-table">
                                âŒ é£Ÿè­œç”Ÿæˆå¤±æ•—ï¼šå…§å®¹ç‚ºç©ºï¼Œè«‹é‡è©¦
                            </div>
                        `;
                        resetMenuButtons();
                    }
                    currentMenuText = '';
                } else if (data.type === 'error') {
                    pageLog('âŒ [MENU] é£Ÿè­œç”ŸæˆéŒ¯èª¤: ' + data.message);
                    isGeneratingMenu = false;
                    document.getElementById('weekly-menu-table').innerHTML = `
                        <div class="empty-menu-table">
                            âŒ é£Ÿè­œç”Ÿæˆå¤±æ•—<br>
                            <small style="color: #666; margin-top: 8px; display: block;">
                                éŒ¯èª¤è©³æƒ…ï¼š${data.message}<br>
                                è«‹æª¢æŸ¥ç¶²è·¯é€£æ¥æˆ–ç¨å¾Œé‡è©¦
                            </small>
                        </div>
                    `;
                    resetMenuButtons();
                } else {
                    pageLog('âš ï¸ [MENU] æœªçŸ¥çš„æ¶ˆæ¯é¡å‹: ' + data.type);
                }
                
                // ğŸš« çµ•å°é˜»æ­¢ï¼šç„¡è«–å¦‚ä½•éƒ½ä¸èƒ½é€²å…¥èŠå¤©è™•ç†é‚è¼¯
                pageLog('ğŸš« [MENU] é˜»æ­¢é£Ÿè­œå…§å®¹é€²å…¥èŠå¤©æ¨¡çµ„');
                return;
            }
            
            // ğŸ›¡ï¸ äºŒé‡ä¿è­·ï¼šå¦‚æœæ­£åœ¨ç”Ÿæˆé£Ÿè­œï¼Œé˜»æ­¢èŠå¤©è¨Šæ¯ï¼ˆä½†ä¸é˜»æ­¢é£Ÿè­œè¨Šæ¯ï¼‰
            if (isGeneratingMenu && data.requestType !== 'weekly-menu') {
                pageLog('ğŸš« [PROTECT] é£Ÿè­œç”Ÿæˆä¸­ï¼Œå¿½ç•¥èŠå¤©è¨Šæ¯');
                return;
            }
            
            // ğŸ›¡ï¸ ä¸‰é‡ä¿è­·ï¼šå…§å®¹æ ¼å¼æª¢æ¸¬ï¼Œå¼·åˆ¶éæ¿¾é£Ÿè­œæ ¼å¼
            if (data.delta && containsMenuContent(data.delta)) {
                pageLog('ğŸš« [PROTECT] æª¢æ¸¬åˆ°é£Ÿè­œæ ¼å¼ï¼Œå¼·åˆ¶éæ¿¾: ' + data.delta.substring(0, 50));
                return;
            }
            
            // ğŸ” æª¢æŸ¥æœªçŸ¥çš„requestType
            if (data.requestType && data.requestType !== 'chat' && data.requestType !== 'weekly-menu') {
                pageLog('âš ï¸ [UNKNOWN] æœªçŸ¥çš„requestType: ' + data.requestType);
            }
            
            // æ­£å¸¸èŠå¤©è™•ç†é‚è¼¯
            pageLog('ğŸ’¬ [CHAT] è™•ç†èŠå¤©éŸ¿æ‡‰: type=' + data.type + ', requestType=' + data.requestType);
            
            if (data.type === 'chunk') {
                let cleanText = data.delta;
                
                // éæ¿¾èª¿è©¦è¨Šæ¯
                if (cleanText.includes('æ­£åœ¨å‚³é€ prompt') || 
                    cleanText.includes('Azure OpenAI å›æ‡‰') || 
                    cleanText.includes('--- å›æ‡‰çµæŸ ---') ||
                    cleanText.includes('>>>>>')) {
                    console.log('ğŸš« [CHAT] éæ¿¾èª¿è©¦è¨Šæ¯');
                    return;
                }
                
                console.log('âœ… [CHAT] é¡¯ç¤ºèŠå¤©å†…å®¹:', cleanText.substring(0, 50));
                appendToLastMessage(cleanText);
            } else if (data.type === 'end') {
                console.log('ğŸ’¬ [CHAT] èŠå¤©éŸ¿æ‡‰çµæŸ');
                enableChatInput();
            } else if (data.type === 'start') {
                console.log('ğŸ’¬ [CHAT] é–‹å§‹èŠå¤©éŸ¿æ‡‰');
                addMessage('ai', '');
                disableChatInput();
            }
        };

        // æª¢æ¸¬æ–‡æœ¬æ˜¯å¦åŒ…å«é£Ÿè­œæ ¼å¼å…§å®¹
        function containsMenuContent(text) {
            const menuPatterns = [
                // æ—¥æœŸæ ¼å¼
                /å‘¨[ä¸€äºŒä¸‰å››äº”å…­æ—¥å¤©]/,
                /æ˜ŸæœŸ[ä¸€äºŒä¸‰å››äº”å…­æ—¥å¤©]/,
                /ç¤¼æ‹œ[ä¸€äºŒä¸‰å››äº”å…­æ—¥å¤©]/,
                /ç¬¬[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒ]å¤©/,
                
                // é¤æ¬¡æ ¼å¼
                /(æ—©é¤|åˆé¤|æ™šé¤|å®µå¤œ)[ï¼š:]\s*\S/,
                /æ—©é¤.*[+ï¼‹]/,
                /åˆé¤.*[+ï¼‹]/,
                /æ™šé¤.*[+ï¼‹]/,
                
                // ç‡Ÿé¤Šæ ¼å¼
                /\d+\s*[å¤§]?å¡[è·¯é‡Œ]*/,
                /æ€»è®¡.*\d+.*å¡/,
                /è›‹ç™½è³ª\s*\d+\s*g/,
                /ç´„\d+å¡/,
                /\d+gè›‹ç™½è³ª/,
                /ç¢³æ°´åŒ–åˆç‰©\s*\d+\s*g/,
                /è„‚è‚ª\s*\d+\s*g/,
                
                // é£Ÿç‰©é€£æ¥æ ¼å¼
                /\S+\s*[+ï¼‹]\s*\S+\s*[+ï¼‹]/,
                
                // ä¸€é€±é£Ÿè­œæ¨™é¡Œæ ¼å¼
                /ä¸€é€±.*é£Ÿè­œ/,
                /ä¸ƒå¤©.*é£Ÿè­œ/,
                /å°ˆå±¬.*é£Ÿè­œ/
            ];
            
            const hasMenuPattern = menuPatterns.some(pattern => pattern.test(text));
            
            if (hasMenuPattern) {
                console.log('ğŸ” [DETECT] æª¢æ¸¬åˆ°é£Ÿè­œæ ¼å¼:', text.substring(0, 100));
            }
            
            return hasMenuPattern;
        }

        // å„²å­˜ä½¿ç”¨è€…è³‡æ–™
        async function saveUserProfile() {
            const age = parseInt(document.getElementById('age').value);
            const height = parseInt(document.getElementById('height').value);
            const weight = parseInt(document.getElementById('weight').value);
            const gender = document.getElementById('gender').value;
            const activity = document.getElementById('activity').value;
            const medicalConditions = document.getElementById('medical-conditions').value.trim();
            const allergies = document.getElementById('allergies').value.trim();

            if (!age || !height || !weight || !gender) {
                // éœé»˜è¿”å›ï¼Œä¸é¡¯ç¤ºå½ˆçª—
                return;
            }

            userProfile = { age, height, weight, gender, activity, medicalConditions, allergies };
            
            // è¨ˆç®—ç‡Ÿé¤Šç›®æ¨™
            const success = await calculateNutritionGoals();
            
            if (success) {
                // å„²å­˜åˆ°æœ¬åœ°å­˜å„²
                localStorage.setItem('userProfile', JSON.stringify(userProfile));
                localStorage.setItem('nutritionGoals', JSON.stringify(nutritionGoals));
                
                await updateRecommendations();
                updateNutritionDisplay();
                updateHealthAlerts();
                
                // å€‹äººè³‡è¨Šå·²å„²å­˜ï¼Œä¸éœ€è¦å½ˆçª—
            } else {
                // å„²å­˜å¤±æ•—ï¼Œä¸éœ€è¦å½ˆçª—
            }
        }

        // è¨ˆç®—ç‡Ÿé¤Šç›®æ¨™ (å‘¼å«å¾Œç«¯API)
        async function calculateNutritionGoals() {
            try {
                const response = await fetch('/api/calculate/bmr', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userProfile)
                });
                
                const data = await response.json();
                if (data.success) {
                    nutritionGoals = data.nutritionGoals;
                    userProfile.bmi = data.bmi;
                    userProfile.bmr = data.bmr;
                    userProfile.dailyCalories = data.dailyCalories;
                    return true;
                }
            } catch (error) {
                console.error('è¨ˆç®—ç‡Ÿé¤Šç›®æ¨™å¤±æ•—:', error);
            }
            
            // å¤±æ•—æ™‚ä½¿ç”¨æœ¬åœ°è¨ˆç®—
            const { age, height, weight, gender, activity } = userProfile;
            
            // åŸºç¤ä»£è¬ç‡è¨ˆç®— (Harris-Benedictå…¬å¼)
            let bmr;
            if (gender === 'male') {
                bmr = 88.362 + (13.397 * weight) + (4.799 * height) - (5.677 * age);
            } else {
                bmr = 447.593 + (9.247 * weight) + (3.098 * height) - (4.330 * age);
            }
            
            // æ´»å‹•ä¿‚æ•¸
            const activityMultipliers = {
                sedentary: 1.2,
                light: 1.375,
                moderate: 1.55,
                high: 1.725,
                very_high: 1.9
            };
            
            const dailyCalories = Math.round(bmr * activityMultipliers[activity]);
            
            nutritionGoals = {
                calories: dailyCalories,
                protein: Math.round(weight * 1.2), // 1.2g/kgé«”é‡
                carbs: Math.round(dailyCalories * 0.45 / 4), // 45%ä¾†è‡ªç¢³æ°´
                fat: Math.round(dailyCalories * 0.25 / 9) // 25%ä¾†è‡ªè„‚è‚ª
            };
            
            return true;
        }

        // é©—è­‰é£Ÿç‰©çœŸå¯¦æ€§
        function validateFoodItem(foodName) {
            console.log('ğŸ” [FOOD-VALIDATION] é–‹å§‹é©—è­‰é£Ÿç‰©:', foodName);
            
            // å¸¸è¦‹çš„éé£Ÿç‰©è©å½™åˆ—è¡¨
            const nonFoodItems = [
                // ç‰©å“é¡
                'æ¡Œå­', 'æ¤…å­', 'é›»è…¦', 'æ‰‹æ©Ÿ', 'è»Šå­', 'æ±½è»Š', 'æ©Ÿè»Š', 'è…³è¸è»Š', 'æ›¸', 'ç­†', 'ç´™', 'è¡£æœ', 'è¤²å­', 'é‹å­', 'è¥ªå­',
                'é›»è¦–', 'å†°ç®±', 'æ´—è¡£æ©Ÿ', 'å†·æ°£', 'é¢¨æ‰‡', 'ç‡ˆ', 'åºŠ', 'æ•é ­', 'æ£‰è¢«', 'æ¯›å·¾', 'ç‰™åˆ·', 'ç‰™è†', 'è‚¥çš‚', 'æ´—é«®ç²¾',
                'åŒ…åŒ…', 'éŒ¢åŒ…', 'æ‰‹éŒ¶', 'çœ¼é¡', 'å¸½å­', 'é›¨å‚˜', 'é‘°åŒ™', 'é–€', 'çª—æˆ¶', 'ç‰†å£', 'åœ°æ¿', 'å¤©èŠ±æ¿',
                
                // é‹å‹•/éŠæˆ²å™¨æ
                'æ’çƒæ¡Œ', 'ä¹’ä¹“çƒæ¡Œ', 'æ¡Œçƒæ¡Œ', 'éº»å°‡æ¡Œ', 'æ’çƒ', 'æ¡Œçƒ', 'ä¹’ä¹“çƒ', 'éº»å°‡', 'çƒæ¡Œ', 'éŠæˆ²æ¡Œ',
                'ç±ƒçƒ', 'è¶³çƒ', 'æ’çƒ', 'ç¶²çƒ', 'ç¾½æ¯›çƒ', 'æ¡ŒéŠ', 'é›»ç©', 'éŠæˆ²æ©Ÿ', 'é›»å‹•', 'éº»å°‡ç‰Œ', 'æ’²å…‹ç‰Œ',
                
                // ææ–™/åŒ–å­¸ç‰©è³ª
                'å¡‘è† ', 'é‡‘å±¬', 'æœ¨é ­', 'çŸ³é ­', 'ç»ç’ƒ', 'æ°´æ³¥', 'æ²¹æ¼†', 'è† æ°´', 'é‡˜å­', 'èºçµ²', 'é›»ç·š', 'ç®¡å­',
                'æ±½æ²¹', 'é…’ç²¾', 'æ°«æ°£', 'æ°§æ°£', 'äºŒæ°§åŒ–ç¢³', 'é¹½é…¸', 'ç¡«é…¸', 'æ°¨æ°´', 'æ¼‚ç™½æ°´', 'æ¸…æ½”åŠ‘',
                
                // æŠ½è±¡æ¦‚å¿µ
                'æ„›æƒ…', 'å‹æƒ…', 'å¿«æ¨‚', 'æ‚²å‚·', 'æ†¤æ€’', 'å®³æ€•', 'é©šè¨', 'æ™‚é–“', 'ç©ºé–“', 'å¤¢æƒ³', 'å¸Œæœ›', 'ä¿¡ä»°',
                'è‡ªç”±', 'å’Œå¹³', 'æˆ°çˆ­', 'æ”¿æ²»', 'ç¶“æ¿Ÿ', 'æ•™è‚²', 'æ–‡åŒ–', 'è—è¡“', 'éŸ³æ¨‚', 'é‹å‹•',
                
                // å‹•ç‰©ï¼ˆæ´»é«”ï¼Œéé£Ÿæï¼‰
                'è²“', 'ç‹—', 'è€é¼ ', 'å…”å­', 'å€‰é¼ ', 'é³¥', 'é­šç¼¸', 'å¯µç‰©', 'æ˜†èŸ²', 'èœ˜è››', 'è›‡', 'ç…å­', 'è€è™', 'å¤§è±¡',
                
                // äººé«”éƒ¨ä½
                'é ­', 'æ‰‹', 'è…³', 'çœ¼ç›', 'é¼»å­', 'å˜´å·´', 'è€³æœµ', 'é ­é«®', 'çš®è†š', 'éª¨é ­', 'è‚Œè‚‰', 'è¡€æ¶²',
                
                // åœ°é»
                'å°åŒ—', 'å°ä¸­', 'å°å—', 'é«˜é›„', 'å­¸æ ¡', 'å…¬å¸', 'é†«é™¢', 'éŠ€è¡Œ', 'è¶…å¸‚', 'é¤å»³', 'å…¬åœ’', 'æµ·é‚Š', 'å±±ä¸Š',
                
                // è·æ¥­/äººç‰©
                'è€å¸«', 'å­¸ç”Ÿ', 'é†«ç”Ÿ', 'è­·å£«', 'è­¦å¯Ÿ', 'æ¶ˆé˜²å“¡', 'å¸æ©Ÿ', 'å»šå¸«', 'å¾‹å¸«', 'å·¥ç¨‹å¸«', 'è€é—†', 'å“¡å·¥',
                
                // ç„¡æ„ç¾©æˆ–æ¸¬è©¦ç”¨è©
                'test', 'testing', 'æ¸¬è©¦', '123', 'abc', 'hello', 'world', 'aaa', 'bbb', 'xxx', 'yyy', 'zzz',
                'qwerty', 'asdf', 'éš¨ä¾¿', 'ä»€éº¼éƒ½å¯ä»¥', 'ä¸çŸ¥é“', 'æ²’æœ‰', 'ç©ºçš„', 'ç„¡',
                
                // ä¸ç•¶å…§å®¹
                'æ¯’å“', 'è—¥å“', 'ç¶­ä»–å‘½', 'ä¿å¥é£Ÿå“', 'ç‡Ÿé¤Šè£œå……åŠ‘', 'è—¥ä¸¸', 'è† å›Š', 'è—¥æ°´'
            ];
            
            // æª¢æŸ¥æ˜¯å¦ç‚ºéé£Ÿç‰©é …ç›® - å®Œå…¨åŒ¹é…
            const lowerFoodName = foodName.toLowerCase();
            console.log('ğŸ” [FOOD-VALIDATION] è½‰ç‚ºå°å¯«:', lowerFoodName);
            
            // é¦–å…ˆæª¢æŸ¥å®Œå…¨åŒ¹é…
            if (nonFoodItems.some(item => lowerFoodName === item.toLowerCase())) {
                console.log('âŒ [FOOD-VALIDATION] å®Œå…¨åŒ¹é…éé£Ÿç‰©é …ç›®');
                return false;
            }
            
            // ç„¶å¾Œæª¢æŸ¥åŒ…å«é—œä¿‚
            const foundItem = nonFoodItems.find(item => lowerFoodName.includes(item.toLowerCase()) || item.toLowerCase().includes(lowerFoodName));
            if (foundItem) {
                console.log('âŒ [FOOD-VALIDATION] åŒ…å«éé£Ÿç‰©é …ç›®:', foundItem);
                return false;
            }
            
            // æª¢æŸ¥æ˜¯å¦ç‚ºç´”æ•¸å­—æˆ–ç´”å­—æ¯
            if (/^\d+$/.test(foodName) || /^[a-zA-Z]+$/.test(foodName)) {
                console.log('âŒ [FOOD-VALIDATION] ç´”æ•¸å­—æˆ–ç´”å­—æ¯');
                return false;
            }
            
            // æª¢æŸ¥æ˜¯å¦ç‚ºç‰¹æ®Šå­—ç¬¦æˆ–éçŸ­
            if (foodName.length < 2 || /[!@#$%^&*()_+=\[\]{}|;:,.<>?]/.test(foodName)) {
                console.log('âŒ [FOOD-VALIDATION] ç‰¹æ®Šå­—ç¬¦æˆ–éçŸ­');
                return false;
            }
            
            console.log('âœ… [FOOD-VALIDATION] é©—è­‰é€šé');
            return true;
        }

        // ğŸ§ª æ¸¬è©¦é©—è­‰åŠŸèƒ½ (å¯åœ¨æ§åˆ¶å°ä½¿ç”¨)
        function testFoodValidation() {
            const testCases = ['æ’çƒæ¡Œ', 'è˜‹æœ', 'test', 'æ¡Œå­', 'é›èƒ¸è‚‰', '123', 'æ„›æƒ…'];
            console.log('ğŸ§ª [TEST] é–‹å§‹æ¸¬è©¦é£Ÿç‰©é©—è­‰åŠŸèƒ½:');
            testCases.forEach(food => {
                const result = validateFoodItem(food);
                console.log(`${result ? 'âœ…' : 'âŒ'} "${food}" -> ${result ? 'æœ‰æ•ˆ' : 'ç„¡æ•ˆ'}`);
            });
        }

        // æ–°å¢é£Ÿç‰©
        async function addFood() {
            const foodName = document.getElementById('food-name').value.trim();
            const amount = parseInt(document.getElementById('food-amount').value);
            
            if (!foodName || !amount) {
                // éœé»˜è¿”å›ï¼Œä¸é¡¯ç¤ºå½ˆçª—
                return;
            }
            
            // é©—è­‰é£Ÿç‰©çœŸå¯¦æ€§
            if (!validateFoodItem(foodName)) {
                // é¡¯ç¤ºé£Ÿç‰©é©—è­‰éŒ¯èª¤æç¤º
                const existingWarning = document.getElementById('food-validation-warning');
                if (existingWarning) {
                    existingWarning.remove();
                }
                
                const warningDiv = document.createElement('div');
                warningDiv.id = 'food-validation-warning';
                warningDiv.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: linear-gradient(135deg, #ff9500, #ff6b35);
                    color: white;
                    padding: 20px 30px;
                    border-radius: 15px;
                    box-shadow: 0 10px 30px rgba(255, 149, 0, 0.3);
                    z-index: 9999;
                    font-size: 16px;
                    font-weight: 600;
                    text-align: center;
                    min-width: 350px;
                    animation: warningPulse 0.5s ease-in-out;
                `;
                warningDiv.innerHTML = `
                    <div style="font-size: 24px; margin-bottom: 10px;">ğŸš« è¼¸å…¥éŒ¯èª¤</div>
                    <div>"${foodName}" ä¸æ˜¯æœ‰æ•ˆçš„é£Ÿç‰©åç¨±</div>
                    <div style="margin-top: 10px; font-size: 14px; opacity: 0.9;">
                        ç³»çµ±åµæ¸¬åˆ°é€™ä¸æ˜¯çœŸæ­£çš„é£Ÿç‰©<br>
                        è«‹è¼¸å…¥å¯é£Ÿç”¨çš„é£Ÿç‰©åç¨±ï¼Œä¾‹å¦‚ï¼š<br>
                        ğŸ è˜‹æœã€ğŸŒ é¦™è•‰ã€ğŸ— é›èƒ¸è‚‰ã€ğŸš ç™½é£¯ã€ğŸ¥¬ é’èœ
                    </div>
                    <div style="margin-top: 15px; font-size: 14px; opacity: 0.9;">æ­¤æé†’å°‡åœ¨4ç§’å¾Œè‡ªå‹•æ¶ˆå¤±</div>
                `;
                
                document.body.appendChild(warningDiv);
                
                // 4ç§’å¾Œè‡ªå‹•ç§»é™¤è­¦å‘Š
                setTimeout(() => {
                    if (document.getElementById('food-validation-warning')) {
                        document.getElementById('food-validation-warning').remove();
                    }
                }, 4000);
                
                // æ¸…ç©ºè¼¸å…¥æ¡†ä½†ä¸æ–°å¢é£Ÿç‰©
                document.getElementById('food-name').value = '';
                document.getElementById('food-amount').value = '';
                return;
            }
            
            // æª¢æŸ¥éæ•åŸ
            const detectedAllergy = checkFoodAllergies(foodName);
            if (detectedAllergy) {
                // å»ºç«‹éæ•åŸè­¦å‘Šæç¤º
                const existingWarning = document.getElementById('allergy-warning');
                if (existingWarning) {
                    existingWarning.remove();
                }
                
                const warningDiv = document.createElement('div');
                warningDiv.id = 'allergy-warning';
                warningDiv.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: linear-gradient(135deg, #ff6b6b, #ee5a24);
                    color: white;
                    padding: 20px 30px;
                    border-radius: 15px;
                    box-shadow: 0 10px 30px rgba(255, 107, 107, 0.3);
                    z-index: 9999;
                    font-size: 16px;
                    font-weight: 600;
                    text-align: center;
                    min-width: 300px;
                    animation: warningPulse 0.5s ease-in-out;
                `;
                warningDiv.innerHTML = `
                    <div style="font-size: 24px; margin-bottom: 10px;">âš ï¸ éæ•åŸè­¦å‘Š</div>
                    <div>æ‚¨å°"${detectedAllergy}"éæ•ï¼Œè«‹å‹¿é£Ÿç”¨"${foodName}"ï¼</div>
                    <div style="margin-top: 15px; font-size: 14px; opacity: 0.9;">æ­¤æé†’å°‡åœ¨3ç§’å¾Œè‡ªå‹•æ¶ˆå¤±</div>
                `;
                
                document.body.appendChild(warningDiv);
                
                // 3ç§’å¾Œè‡ªå‹•ç§»é™¤è­¦å‘Š
                setTimeout(() => {
                    if (document.getElementById('allergy-warning')) {
                        document.getElementById('allergy-warning').remove();
                    }
                }, 3000);
                
                // æ¸…ç©ºè¼¸å…¥æ¡†ä½†ä¸æ–°å¢é£Ÿç‰©
                document.getElementById('food-name').value = '';
                document.getElementById('food-amount').value = '';
                return;
            }
            
            // å–å¾—é£Ÿç‰©ç‡Ÿé¤Šè³‡è¨Š (é€™è£¡ä½¿ç”¨æ¨¡æ“¬è³‡æ–™)
            const nutrition = await getFoodNutrition(foodName, amount);
            
            const foodItem = {
                name: foodName,
                amount: amount,
                time: new Date().toLocaleTimeString(),
                ...nutrition
            };
            
            todayFood.push(foodItem);
            
            // å„²å­˜åˆ°æœ¬åœ°å­˜å„²
            localStorage.setItem('todayFood', JSON.stringify(todayFood));
            
            // æ›´æ–°é¡¯ç¤º
            updateFoodLog();
            updateNutritionDisplay();
            updateRecommendations(); // æ›´æ–°å»ºè­°
            
            // æ¸…ç©ºè¼¸å…¥æ¡†
            document.getElementById('food-name').value = '';
            document.getElementById('food-amount').value = '';
        }

        // å–å¾—é£Ÿç‰©ç‡Ÿé¤Šè³‡è¨Š (å‘¼å«å¾Œç«¯API)
        async function getFoodNutrition(foodName, amount) {
            try {
                const response = await fetch(`/api/food/${encodeURIComponent(foodName)}`);
                const data = await response.json();
                
                if (data.success) {
                    const nutrition = data.nutrition;
                    return {
                        calories: Math.round(nutrition.calories * amount / 100),
                        protein: Math.round(nutrition.protein * amount / 100 * 10) / 10,
                        carbs: Math.round(nutrition.carbs * amount / 100 * 10) / 10,
                        fat: Math.round(nutrition.fat * amount / 100 * 10) / 10,
                        fiber: Math.round(nutrition.fiber * amount / 100 * 10) / 10,
                        sugar: Math.round(nutrition.sugar * amount / 100 * 10) / 10,
                        isEstimate: data.isEstimate
                    };
                }
            } catch (error) {
                console.error('å–å¾—ç‡Ÿé¤Šè³‡è¨Šå¤±æ•—:', error);
            }
            
            // å¤±æ•—æ™‚è¿”å›é è¨­å€¼
            return {
                calories: Math.round(50 * amount / 100),
                protein: Math.round(1 * amount / 100 * 10) / 10,
                carbs: Math.round(10 * amount / 100 * 10) / 10,
                fat: Math.round(0.5 * amount / 100 * 10) / 10,
                fiber: Math.round(1 * amount / 100 * 10) / 10,
                sugar: Math.round(2 * amount / 100 * 10) / 10,
                isEstimate: true
            };
        }

        // æ›´æ–°é£Ÿç‰©æ—¥èªŒé¡¯ç¤º
        function updateFoodLog() {
            const foodLog = document.getElementById('food-log');
            foodLog.innerHTML = '';
            
            todayFood.forEach((food, index) => {
                const foodItem = document.createElement('div');
                foodItem.className = 'food-item';
                foodItem.innerHTML = `
                    <div class="info">
                        <div class="name">${food.name}</div>
                        <div class="details">${food.amount}g Â· ${food.time}</div>
                    </div>
                    <div class="calories">${food.calories}å¡</div>
                    <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;" onclick="removeFood(${index})">åˆªé™¤</button>
                `;
                foodLog.appendChild(foodItem);
            });
        }

        // åˆªé™¤é£Ÿç‰©
        function removeFood(index) {
            todayFood.splice(index, 1);
            localStorage.setItem('todayFood', JSON.stringify(todayFood));
            updateFoodLog();
            updateNutritionDisplay();
        }

        // æ¸…ç©ºä»Šæ—¥è¨˜éŒ„
        function clearTodayLog() {
            // ç›´æ¥æ¸…ç©ºï¼Œä¸éœ€è¦ç¢ºèªå½ˆçª—
            todayFood = [];
            localStorage.removeItem('todayFood');
            updateFoodLog();
            updateNutritionDisplay();
        }

        // æ›´æ–°å¥åº·æé†’
        function updateHealthAlerts() {
            const healthAlertsCard = document.getElementById('health-alerts');
            const healthAlertsContent = document.getElementById('health-alerts-content');
            
            let hasAlerts = false;
            let alertsHtml = '';
            
            // æª¢æŸ¥éæ•åŸæé†’
            if (userProfile.allergies && userProfile.allergies.trim()) {
                hasAlerts = true;
                const allergiesList = userProfile.allergies.split(/[,ï¼Œã€\n]/).map(item => item.trim()).filter(item => item);
                alertsHtml += `
                    <div class="alert-item danger">
                        <div class="alert-icon">âš ï¸</div>
                        <div class="alert-content">
                            <div class="alert-title">éæ•åŸè­¦å‘Š</div>
                            <div class="alert-description">æ‚¨å°ä»¥ä¸‹é£Ÿç‰©éæ•ï¼š${allergiesList.join('ã€')}ã€‚è«‹å‹™å¿…é¿å…é£Ÿç”¨é€™äº›é£Ÿç‰©åŠå…¶è£½å“ã€‚</div>
                        </div>
                    </div>
                `;
            }
            
            // æª¢æŸ¥ç‰¹æ®Šç–¾ç—…æé†’
            if (userProfile.medicalConditions && userProfile.medicalConditions.trim()) {
                hasAlerts = true;
                const conditions = userProfile.medicalConditions.toLowerCase();
                
                // ç³–å°¿ç—…æé†’
                if (conditions.includes('ç³–å°¿ç—…') || conditions.includes('è¡€ç³–')) {
                    alertsHtml += `
                        <div class="alert-item warning">
                            <div class="alert-icon">ğŸ©º</div>
                            <div class="alert-content">
                                <div class="alert-title">ç¬¬äºŒå‹ç³–å°¿ç—…å°ˆæ¥­é£²é£ŸæŒ‡å°</div>
                                <div class="alert-description">ã€é¿å…ã€‘é«˜å‡ç³–æŒ‡æ•¸é£Ÿç‰©ï¼šç™½ç±³é£¯ã€ç™½éºµåŒ…ã€ç³–æœã€å«ç³–é£²æ–™ã€ç²¾è£½é£Ÿå“ã€‚ã€æ¨è–¦ã€‘ä½å‡ç³–é£Ÿç‰©ï¼šå…¨ç©€ç‰©ã€é«˜çº–ç¶­è”¬èœã€ç˜¦è‚‰è›‹ç™½ã€å¥åº·è„‚è‚ªã€‚ã€åŸå‰‡ã€‘å®šæ™‚å®šé‡é€²é¤ï¼Œè¡€ç³–ç›£æ¸¬ï¼Œç‡Ÿé¤Šå‡è¡¡ã€‚</div>
                            </div>
                        </div>
                    `;
                }
                
                // é«˜è¡€å£“æé†’
                if (conditions.includes('é«˜è¡€å£“') || conditions.includes('è¡€å£“')) {
                    alertsHtml += `
                        <div class="alert-item warning">
                            <div class="alert-icon">â¤ï¸</div>
                            <div class="alert-content">
                                <div class="alert-title">é«˜è¡€å£“å°ˆæ¥­é£²é£Ÿç®¡ç†</div>
                                <div class="alert-description">ã€é™åˆ¶éˆ‰æ”å–ã€‘æ¯æ—¥<2.3gï¼Œé¿å…åŠ å·¥é£Ÿå“ã€é†ƒè£½å“ã€é¹¹èœã€‚ã€DASHé£²é£Ÿã€‘å¯Œå«é‰€è”¬æœ(é¦™è•‰ã€è èœ)ã€ä½è„‚ä¹³è£½å“ã€å…¨ç©€ç‰©ã€‚ã€ç›£æ¸¬ã€‘å®šæœŸè¡€å£“æ¸¬é‡ï¼Œé«”é‡æ§åˆ¶ã€‚</div>
                            </div>
                        </div>
                    `;
                }
                
                // å¿ƒè„ç—…æé†’
                if (conditions.includes('å¿ƒè„ç—…') || conditions.includes('å¿ƒè¡€ç®¡')) {
                    alertsHtml += `
                        <div class="alert-item warning">
                            <div class="alert-icon">ğŸ’“</div>
                            <div class="alert-content">
                                <div class="alert-title">å¿ƒè‡Ÿç—…/å¿ƒè¡€ç®¡ç–¾ç—…å°ˆæ¥­ç‡Ÿé¤Š</div>
                                <div class="alert-description">ã€é™åˆ¶ã€‘é£½å’Œè„‚è‚ªã€åå¼è„‚è‚ªã€é«˜è†½å›ºé†‡é£Ÿç‰©ã€‚ã€æ¨è–¦ã€‘å¯Œå«Omega-3æ·±æµ·é­šé¡ã€å …æœã€æ©„æ¬–æ²¹ã€ç‡•éº¥Î²-è‘¡èšç³–ã€‚ã€ç›®æ¨™ã€‘é™ä½LDLè†½å›ºé†‡ï¼Œæ§åˆ¶é«”é‡ï¼Œåœ°ä¸­æµ·é£²é£Ÿæ¨¡å¼ã€‚</div>
                            </div>
                        </div>
                    `;
                }
                
                // ç—›é£æé†’
                if (conditions.includes('ç—›é£') || conditions.includes('å°¿é…¸')) {
                    alertsHtml += `
                        <div class="alert-item warning">
                            <div class="alert-icon">ğŸ¦´</div>
                            <div class="alert-content">
                                <div class="alert-title">ç—›é¢¨/é«˜å°¿é…¸è¡€ç—‡å°ˆæ¥­ç®¡ç†</div>
                                <div class="alert-description">ã€åš´æ ¼é¿å…ã€‘é«˜å˜Œå‘¤é£Ÿç‰©ï¼šå…§è‡Ÿã€æµ·é®®ã€é…’ç²¾ã€è‚‰æ¹¯ã€‚ã€æ¨è–¦ã€‘ä½è„‚ä¹³è£½å“ã€è”¬èœã€æ«»æ¡ƒ(æŠ—ç‚)ã€å……è¶³æ°´åˆ†(>2L/æ—¥)ã€‚ã€ç›®æ¨™ã€‘ç¶­æŒå°¿é…¸<6mg/dLï¼Œé«”é‡æ§åˆ¶ã€‚</div>
                            </div>
                        </div>
                    `;
                }
                
                // è‚¾ç—…æé†’
                if (conditions.includes('è‚¾ç—…') || conditions.includes('è‚¾åŠŸèƒ½')) {
                    alertsHtml += `
                        <div class="alert-item warning">
                            <div class="alert-icon">ğŸ«˜</div>
                            <div class="alert-content">
                                <div class="alert-title">è…è‡Ÿç–¾ç—…å°ˆæ¥­ç‡Ÿé¤Šç®¡ç†</div>
                                <div class="alert-description">ã€åš´æ ¼é™åˆ¶ã€‘è›‹ç™½è³ªæ”å–(æ ¹æ“šè…åŠŸèƒ½èª¿æ•´)ã€é«˜ç£·é£Ÿç‰©ã€é«˜é‰€é£Ÿç‰©ã€‚ã€æ§åˆ¶ã€‘éˆ‰å’Œæ°´åˆ†æ”å–ã€‚ã€ç›£æ¸¬ã€‘è…åŠŸèƒ½æŒ‡æ¨™ã€é›»è§£è³ªå¹³è¡¡ã€‚ã€å»ºè­°ã€‘ç‡Ÿé¤Šå¸«å°ˆæ¥­æŒ‡å°ã€‚</div>
                            </div>
                        </div>
                    `;
                }
                
                // è´«è¡€æé†’
                if (conditions.includes('è´«è¡€') || conditions.includes('ç¼ºé“')) {
                    alertsHtml += `
                        <div class="alert-item warning">
                            <div class="alert-icon">ğŸ©¸</div>
                            <div class="alert-content">
                                <div class="alert-title">è²§è¡€å°ˆæ¥­ç‡Ÿé¤Šè£œå……</div>
                                <div class="alert-description">ã€å¢åŠ ã€‘å¯Œå«éµè³ªé£Ÿç‰©ï¼šç´…è‚‰ã€è‚è‡Ÿã€è èœã€‚ã€ä¿ƒé€²å¸æ”¶ã€‘ç¶­ç”Ÿç´ Cé£Ÿç‰©ï¼šæŸ‘æ©˜é¡ã€å¥‡ç•°æœã€‚ã€é¿å…ã€‘èŒ¶å’–å•¡èˆ‡éµåŠ‘åŒæœã€‚ã€è£œå……ã€‘è‘‰é…¸ã€ç¶­ç”Ÿç´ B12ã€‚</div>
                            </div>
                        </div>
                    `;
                }
                
                // è‚¥èƒ–æé†’
                if (conditions.includes('è‚¥èƒ–') || conditions.includes('è¶…é‡') || conditions.includes('æ¸›è‚¥')) {
                    alertsHtml += `
                        <div class="alert-item warning">
                            <div class="alert-icon">âš–ï¸</div>
                            <div class="alert-content">
                                <div class="alert-title">è‚¥èƒ–/è¶…é‡å°ˆæ¥­ç®¡ç†</div>
                                <div class="alert-description">ã€ç†±é‡æ§åˆ¶ã€‘å‰µé€ ç†±é‡ç¼ºå£ï¼Œé©åº¦æ¸›é‡ã€‚ã€é£Ÿç‰©é¸æ“‡ã€‘é«˜çº–ç¶­ã€ä½èƒ½é‡å¯†åº¦é£Ÿç‰©ã€‚ã€é£²é£Ÿæ¨¡å¼ã€‘åˆ†é‡æ§åˆ¶ã€è¦å¾‹é€²é¤ã€‚ã€ç”Ÿæ´»æ–¹å¼ã€‘çµåˆé‹å‹•ï¼Œé•·æœŸç¶­æŒã€‚</div>
                            </div>
                        </div>
                    `;
                }
                
                // ç™Œç—‡æé†’
                if (conditions.includes('ç™Œç—‡') || conditions.includes('è‚¿ç˜¤') || conditions.includes('ç™Œ')) {
                    alertsHtml += `
                        <div class="alert-item warning">
                            <div class="alert-icon">ğŸ—ï¸</div>
                            <div class="alert-content">
                                <div class="alert-title">ç™Œç—‡å°ˆæ¥­ç‡Ÿé¤Šæ”¯æŒ</div>
                                <div class="alert-description">ã€æŠ—æ°§åŒ–ã€‘å¤šæ¨£åŒ–è”¬æœã€åå­—èŠ±ç§‘è”¬èœã€‚ã€é™åˆ¶ã€‘åŠ å·¥è‚‰é¡ã€ç´…è‚‰ã€é…’ç²¾ã€‚ã€å¢å¼·ã€‘å…ç–«æ”¯æŒé£Ÿç‰©ã€å„ªè³ªè›‹ç™½è³ªã€‚ã€ç¶­æŒã€‘é«”é‡ç©©å®šï¼Œç‡Ÿé¤Šå……è¶³ã€‚</div>
                            </div>
                        </div>
                    `;
                }
                
                // è¡€è„‚å¼‚å¸¸æé†’
                if (conditions.includes('è¡€è„‚') || conditions.includes('èƒ†å›ºé†‡') || conditions.includes('é«˜è„‚è¡€ç—‡')) {
                    alertsHtml += `
                        <div class="alert-item warning">
                            <div class="alert-icon">ğŸ§ª</div>
                            <div class="alert-content">
                                <div class="alert-title">è¡€è„‚ç•°å¸¸å°ˆæ¥­èª¿ç†</div>
                                <div class="alert-description">ã€æ¸›å°‘ã€‘é£½å’Œè„‚è‚ªã€åå¼è„‚è‚ªã€‚ã€å¢åŠ ã€‘ä¸é£½å’Œè„‚è‚ªé…¸ã€ç‡•éº¥Î²-è‘¡èšç³–ã€‚ã€é¸æ“‡ã€‘è±†é¡è£½å“ã€å …æœã€æ·±æµ·é­šã€‚ã€æ§åˆ¶ã€‘ç²¾è£½ç³–ï¼Œç¶­æŒç†æƒ³é«”é‡ã€‚</div>
                            </div>
                        </div>
                    `;
                }
                
                // ç‡Ÿé¤Šä¸è‰¯æé†’
                if (conditions.includes('ç‡Ÿé¤Šä¸è‰¯') || conditions.includes('ç‡Ÿé¤Šç¼ºä¹') || conditions.includes('æ¶ˆç˜¦')) {
                    alertsHtml += `
                        <div class="alert-item warning">
                            <div class="alert-icon">ğŸ“ˆ</div>
                            <div class="alert-content">
                                <div class="alert-title">ç‡Ÿé¤Šä¸è‰¯å°ˆæ¥­æ”¹å–„</div>
                                <div class="alert-description">ã€å¢åŠ ã€‘é«˜è³ªé‡è›‹ç™½è³ªã€å¥åº·è„‚è‚ªã€‚ã€é¿å…ã€‘ç²¾è£½ç¢³æ°´åŒ–åˆç‰©ã€ç©ºç†±é‡é£Ÿç‰©ã€‚ã€è£œå……ã€‘ç¶­ç”Ÿç´ ç¤¦ç‰©è³ªã€å¤šæ¨£åŒ–ç‡Ÿé¤Šç´ ã€‚ã€ç›£æ¸¬ã€‘é«”é‡å¢é•·ã€ç‡Ÿé¤Šç‹€æ…‹ã€‚</div>
                            </div>
                        </div>
                    `;
                }
                
                // éª¨è³ªç–é¬†æé†’
                if (conditions.includes('éª¨è³ªç–é¬†') || conditions.includes('éª¨å¯†åº¦') || conditions.includes('ç¼ºéˆ£')) {
                    alertsHtml += `
                        <div class="alert-item warning">
                            <div class="alert-icon">ğŸ¦´</div>
                            <div class="alert-content">
                                <div class="alert-title">éª¨è³ªç–é¬†å°ˆæ¥­é é˜²</div>
                                <div class="alert-description">ã€å¢åŠ ã€‘éˆ£è³ªä¾†æºï¼šä¹³è£½å“ã€ç¶ è‘‰è”¬èœã€èŠéº»ã€‚ã€è£œå……ã€‘ç¶­ç”Ÿç´ Dã€é©é‡è›‹ç™½è³ªã€‚ã€é™åˆ¶ã€‘å’–å•¡å› ã€é…’ç²¾ã€é«˜é¹½ã€‚ã€çµåˆã€‘è² é‡é‹å‹•ã€‚</div>
                            </div>
                        </div>
                    `;
                }
            }
            
            // é¡¯ç¤ºæˆ–éš±è—å¥åº·æé†’å¡ç‰‡
            if (hasAlerts) {
                healthAlertsContent.innerHTML = alertsHtml;
                healthAlertsCard.style.display = 'block';
            } else {
                healthAlertsCard.style.display = 'none';
            }
        }

        // æª¢æŸ¥é£Ÿç‰©æ˜¯å¦å«æœ‰éæ•åŸ
        function checkFoodAllergies(foodName) {
            if (!userProfile.allergies || !userProfile.allergies.trim()) {
                return null; // æ²’æœ‰éæ•åŸè³‡è¨Š
            }
            
            const allergiesList = userProfile.allergies.split(/[,ï¼Œã€\n]/).map(item => item.trim().toLowerCase()).filter(item => item);
            const foodNameLower = foodName.toLowerCase();
            
            for (let allergy of allergiesList) {
                if (foodNameLower.includes(allergy) || allergy.includes(foodNameLower)) {
                    return allergy; // ç™¼ç¾éæ•åŸ
                }
            }
            
            return null; // æœªç™¼ç¾éæ•åŸ
        }

        // æ›´æ–°ç‡Ÿé¤Šæ”å–é¡¯ç¤º
        function updateNutritionDisplay() {
            const consumed = todayFood.reduce((total, food) => ({
                calories: total.calories + food.calories,
                protein: total.protein + food.protein,
                carbs: total.carbs + food.carbs,
                fat: total.fat + food.fat
            }), { calories: 0, protein: 0, carbs: 0, fat: 0 });
            
            document.getElementById('calories-consumed').textContent = consumed.calories;
            document.getElementById('protein-consumed').textContent = consumed.protein.toFixed(1) + 'g';
            document.getElementById('carbs-consumed').textContent = consumed.carbs.toFixed(1) + 'g';
            document.getElementById('fat-consumed').textContent = consumed.fat.toFixed(1) + 'g';
            
            // æ›´æ–°é€²åº¦ç’°
            if (nutritionGoals.calories) {
                const percentage = Math.min(100, Math.round(consumed.calories / nutritionGoals.calories * 100));
                const circumference = 2 * Math.PI * 30;
                const offset = circumference - (percentage / 100 * circumference);
                
                document.getElementById('calorie-progress').style.strokeDashoffset = offset;
                document.getElementById('calorie-text').textContent = percentage + '%';
            }
        }

        // å‚³é€è¨Šæ¯çµ¦AIåŠ©ç†
        function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            addMessage('user', message);
            input.value = '';
            
            // æ™ºèƒ½æª¢æ¸¬æ˜¯å¦æ˜¯é£Ÿè­œç”Ÿæˆè«‹æ±‚
            if (isMenuGenerationRequest(message)) {
                // å¦‚æœæª¢æ¸¬åˆ°é£Ÿè­œç”Ÿæˆé—œéµè©ï¼Œè‡ªå‹•è§¸ç™¼é£Ÿè­œç”Ÿæˆ
                addMessage('ai', 'ğŸ¤– å·²æ”¶åˆ°æ‚¨çš„é£Ÿè­œç”Ÿæˆè«‹æ±‚ï¼\n\nğŸ“‹ æ­£åœ¨å•Ÿå‹•é£Ÿè­œç”ŸæˆåŠŸèƒ½...\n\nâœ… è«‹æŸ¥çœ‹ä¸‹æ–¹çš„ã€æˆ‘çš„ä¸€é€±é£Ÿè­œã€‘æ¨¡çµ„æŸ¥çœ‹ç”Ÿæˆçµæœã€‚');
                
                // ç¢ºä¿ç«‹å³è§¸ç™¼é£Ÿè­œç”Ÿæˆ
                console.log('ğŸ¯ [CHAT-TRIGGER] å¾èŠå¤©è§¸ç™¼é£Ÿè­œç”Ÿæˆ');
                generateWeeklyMenu();
                return;
            }
            
            // æ§‹å»ºæ™®é€šç‡Ÿé¤Šè«®è©¢çš„prompt
            const contextPrompt = buildNutritionConsultationPrompt(message);
            
            // å‚³é€èŠå¤©è«‹æ±‚
            ws.send(JSON.stringify({ 
                prompt: contextPrompt,
                requestType: 'chat' // æ˜ç¢ºæ¨™è­˜ç‚ºèŠå¤©è«‹æ±‚
            }));
        }

        // æª¢æ¸¬æ˜¯å¦æ˜¯é£Ÿè­œç”Ÿæˆè«‹æ±‚
        function isMenuGenerationRequest(message) {
            const menuKeywords = [
                // ç¹é«”ä¸­æ–‡ - ç›´æ¥ç”Ÿæˆç›¸é—œ
                'ç”Ÿæˆé£Ÿè­œ', 'è£½å®šé£Ÿè­œ', 'åšå€‹é£Ÿè­œ', 'çµ¦å€‹é£Ÿè­œ', 'ä¾†å€‹é£Ÿè­œ',
                'ä¸€é€±é£Ÿè­œ', 'ä¸ƒå¤©é£Ÿè­œ', 'é€±é£Ÿè­œ', '7å¤©é£Ÿè­œ',
                
                // ç¹é«”ä¸­æ–‡ - è¨ˆç•«å®‰æ’ç›¸é—œ
                'é£Ÿè­œè¨ˆç•«', 'é£²é£Ÿè¨ˆç•«', 'è†³é£Ÿè¨ˆç•«', 'ç‡Ÿé¤Šè¨ˆç•«', 'æ¸›è‚¥è¨ˆç•«',
                'ä¸€é€±é£²é£Ÿ', 'ä¸ƒå¤©é£²é£Ÿ', 'ä¸€é€±èœå–®', 'ä¸ƒå¤©èœå–®', '7å¤©èœå–®',
                'è£½å®šèœå–®', 'ç”Ÿæˆèœå–®', 'é€±èœå–®', 'é£Ÿè­œå®‰æ’',
                'é£²é£Ÿå®‰æ’', 'è†³é£Ÿå®‰æ’', 'ä¸€é€±é¤å–®', 'ä¸ƒå¤©é¤å–®',
                
                // ç¹é«”ä¸­æ–‡ - è«‹æ±‚å”åŠ©ç›¸é—œ
                'å¹«æˆ‘å®‰æ’ä¸€é€±', 'çµ¦æˆ‘è£½å®šä¸€é€±', 'ç‚ºæˆ‘è¦åŠƒä¸€é€±', 'å¹«æˆ‘åšä¸€é€±',
                'å¹«æˆ‘è¦åŠƒé£²é£Ÿ', 'å¹«æˆ‘å®‰æ’é£²é£Ÿ', 'ç‚ºæˆ‘å®‰æ’é£²é£Ÿ', 'çµ¦æˆ‘å®‰æ’é£²é£Ÿ',
                
                // ç¹é«”ä¸­æ–‡ - æ¸›è‚¥/å¥èº«ç›¸é—œ
                'æ¸›è‚¥é£Ÿè­œ', 'å¥èº«é£Ÿè­œ', 'å¢è‚Œé£Ÿè­œ', 'ç˜¦èº«é£Ÿè­œ',
                'æ¸›è„‚é¤', 'å¥èº«é¤', 'å¢è‚Œé¤', 'æ¸›è‚¥é¤',
                
                // ç¹é«”ä¸­æ–‡ - é€±æœŸæ€§æè¿°
                'ä¸€é€±åƒä»€éº¼', 'ä¸ƒå¤©åƒä»€éº¼', 'é€™é€±åƒä»€éº¼', 'ä¸‹é€±åƒä»€éº¼',
                'ä¸€æ˜ŸæœŸåƒä»€éº¼', 'é€™æ˜ŸæœŸåƒä»€éº¼',
                
                // ç¹é«”ä¸­æ–‡ - å…¼å®¹ç°¡é«”è¼¸å…¥
                'ç”Ÿæˆé£Ÿè­œ', 'åˆ¶å®šé£Ÿè­œ', 'åšå€‹é£Ÿè­œ', 'çµ¦å€‹é£Ÿè­œ', 'ä¾†å€‹é£Ÿè­œ',
                'ä¸€é€±é£Ÿè­œ', 'ä¸ƒå¤©é£Ÿè­œ', 'é€±é£Ÿè­œ', '7å¤©é£Ÿè­œ',
                'é£Ÿè­œè¨ˆåŠƒ', 'é£²é£Ÿè¨ˆåŠƒ', 'è†³é£Ÿè¨ˆåŠƒ', 'ç‡Ÿé¤Šè¨ˆåŠƒ', 'æ¸›è‚¥è¨ˆåŠƒ',
                'ä¸€é€±é£²é£Ÿ', 'ä¸ƒå¤©é£²é£Ÿ', 'ä¸€é€±èœå–®', 'ä¸ƒå¤©èœå–®', '7å¤©èœå–®',
                'åˆ¶å®šèœå–®', 'ç”Ÿæˆèœå–®', 'é€±èœå–®', 'é£Ÿè­œå®‰æ’',
                'é£²é£Ÿå®‰æ’', 'è†³é£Ÿå®‰æ’', 'ä¸€é€±é¤å–®', 'ä¸ƒå¤©é¤å–®',
                'å¹«æˆ‘å®‰æ’ä¸€é€±', 'çµ¦æˆ‘åˆ¶å®šä¸€é€±', 'ç‚ºæˆ‘è¦åŠƒä¸€é€±', 'å¹«æˆ‘åšä¸€é€±',
                'å¹«æˆ‘è¦åŠƒé£²é£Ÿ', 'å¹«æˆ‘å®‰æ’é£²é£Ÿ', 'ç‚ºæˆ‘å®‰æ’é£²é£Ÿ', 'çµ¦æˆ‘å®‰æ’é£²é£Ÿ',
                'æ¸›è‚¥é£Ÿè­œ', 'å¥èº«é£Ÿè­œ', 'å¢è‚Œé£Ÿè­œ', 'ç˜¦èº«é£Ÿè­œ',
                'æ¸›è„‚é¤', 'å¥èº«é¤', 'å¢è‚Œé¤', 'æ¸›è‚¥é¤',
                'ä¸€é€±åƒä»€éº¼', 'ä¸ƒå¤©åƒä»€éº¼', 'é€™é€±åƒä»€éº¼', 'ä¸‹é€±åƒä»€éº¼',
                'ä¸€æ˜ŸæœŸåƒä»€éº¼', 'é€™æ˜ŸæœŸåƒä»€éº¼'
            ];
            
            const lowerMessage = message.toLowerCase().replace(/\s+/g, ''); // ç§»é™¤ç©ºæ ¼é€²è¡ŒåŒ¹é…
            return menuKeywords.some(keyword => lowerMessage.includes(keyword.replace(/\s+/g, '')));
        }

        // æ§‹å»ºç‡Ÿé¤Šè«®è©¢çš„promptï¼ˆä¸åŒ…å«é£Ÿè­œç”ŸæˆæŒ‡ä»¤ï¼‰
        function buildNutritionConsultationPrompt(userMessage) {
            let context = `ä½ æ˜¯å°ˆæ¥­çš„AIç‡Ÿé¤Šå¸«åŠ©ç†ï¼Œå°ˆé–€ç‚ºä½¿ç”¨è€…æä¾›ç‡Ÿé¤Šè«®è©¢å’Œå¥åº·é£²é£Ÿå»ºè­°ã€‚è«‹é‡å°ä½¿ç”¨è€…çš„å…·é«”å•é¡Œçµ¦å‡ºç°¡æ½”ã€å°ˆæ¥­çš„å›ç­”ã€‚

ã€é‡è¦èªè¨€è¦æ±‚ã€‘è«‹ä½¿ç”¨ç¹é«”ä¸­æ–‡å›ç­”ï¼Œä¸¦ä½¿ç”¨å°ç£çš„é£Ÿç‰©ç”¨è©ï¼ˆä¾‹å¦‚ï¼šç•ªèŒ„è€Œéè¥¿ç´…æŸ¿ã€ç´…è˜¿è””è€Œéèƒ¡è˜¿è””ã€é¦¬éˆ´è–¯è€ŒéåœŸè±†ç­‰ï¼‰ã€‚

ã€é‡è¦ã€‘ä½ åªéœ€è¦å›ç­”ä½¿ç”¨è€…çš„å…·é«”å•é¡Œï¼Œä¸è¦ä¸»å‹•ç”Ÿæˆå®Œæ•´çš„é£Ÿè­œæˆ–ä¸€é€±é£²é£Ÿè¨ˆç•«ï¼Œé™¤éä½¿ç”¨è€…æ˜ç¢ºè¦æ±‚ã€‚`;
            
            // æ–°å¢ä½¿ç”¨è€…èƒŒæ™¯è³‡è¨Šï¼ˆå¦‚æœæœ‰ï¼‰
            if (Object.keys(userProfile).length > 0) {
                context += `\n\nã€ä½¿ç”¨è€…èƒŒæ™¯ã€‘\nå¹´é½¡ï¼š${userProfile.age}æ­²\næ€§åˆ¥ï¼š${userProfile.gender === 'male' ? 'ç”·' : 'å¥³'}\nèº«é«˜ï¼š${userProfile.height}cm\né«”é‡ï¼š${userProfile.weight}kg`;
                
                // æ–°å¢å¥åº·è³‡è¨Š
                if (userProfile.medicalConditions && userProfile.medicalConditions.trim()) {
                    context += `\nç‰¹æ®Šç–¾ç—…ï¼š${userProfile.medicalConditions}`;
                }
                if (userProfile.allergies && userProfile.allergies.trim()) {
                    context += `\néæ•åŸï¼š${userProfile.allergies}`;
                }
            }
            
            // æ–°å¢ä»Šæ—¥æ”å–è³‡è¨Šï¼ˆå¦‚æœå•é¡Œç›¸é—œï¼‰
            if (todayFood.length > 0 && (userMessage.includes('ä»Šå¤©') || userMessage.includes('ç‡Ÿé¤Š') || userMessage.includes('å¤ ') || userMessage.includes('æ”å–'))) {
                const consumed = todayFood.reduce((total, food) => ({
                    calories: total.calories + food.calories,
                    protein: total.protein + food.protein,
                    carbs: total.carbs + food.carbs,
                    fat: total.fat + food.fat
                }), { calories: 0, protein: 0, carbs: 0, fat: 0 });
                
                context += `\n\nã€ä»Šæ—¥æ”å–æƒ…æ³ã€‘\nå·²æ”å–ï¼š${consumed.calories}å¡ï¼Œè›‹ç™½è³ª${consumed.protein.toFixed(1)}gï¼Œç¢³æ°´${consumed.carbs.toFixed(1)}gï¼Œè„‚è‚ª${consumed.fat.toFixed(1)}g\nç›®æ¨™ï¼š${nutritionGoals.calories}å¡ï¼Œè›‹ç™½è³ª${nutritionGoals.protein}gï¼Œç¢³æ°´${nutritionGoals.carbs}gï¼Œè„‚è‚ª${nutritionGoals.fat}g`;
            }
            
            context += `\n\nã€ä½¿ç”¨è€…å•é¡Œã€‘"${userMessage}"

ã€å›ç­”è¦æ±‚ã€‘
1. é‡å°ä½¿ç”¨è€…çš„å…·é«”å•é¡Œé€²è¡Œå°ˆæ¥­å›ç­”
2. å¦‚æœæ¶‰åŠé£Ÿç‰©æ¨è–¦ï¼Œå¯ä»¥å»ºè­°1-3æ¨£å…·é«”é£Ÿç‰©ï¼Œä½†ä¸è¦åˆ¶å®šå®Œæ•´é¤å–®
3. ä½¿ç”¨ç°¡æ½”çš„æ–‡å­—ï¼Œé¿å…éé•·çš„å›ç­”
4. é‡è¦è³‡è¨Šç”¨ã€ã€‘æ¨™è¨˜ï¼Œå¦‚ã€å»ºè­°ã€‘ã€æ³¨æ„ã€‘ã€é¿å…ã€‘
5. åš´æ ¼éµå¾ªä½¿ç”¨è€…çš„å¥åº·ç‹€æ³å’Œéæ•è³‡è¨Š
6. å¦‚æœä½¿ç”¨è€…æƒ³è¦å®Œæ•´çš„é£Ÿè­œè¨ˆç•«ï¼Œè«‹æé†’ä½¿ç”¨è€…é»æ“Š"ç”Ÿæˆå°ˆå±¬ä¸€é€±é£Ÿè­œ"æŒ‰éˆ•
7. å¿…é ˆä½¿ç”¨ç¹é«”ä¸­æ–‡å’Œå°ç£é£Ÿç‰©ç”¨è©å›ç­”

è«‹å›ç­”ï¼š`;
            
            return context;
        }

        // æ™ºèƒ½æ–‡æœ¬æ ¼å¼åŒ–å‡½æ•°
        function markdownToHtml(text) {
            if (!text) return '';
            
            // ç¬¬ä¸€æ­¥ï¼šå½»åº•æ¸…ç†æ‰€æœ‰ä¹±ç ç¬¦å·
            let cleanText = text
                // ç§»é™¤æ‰€æœ‰markdownç¬¦å·
                .replace(/\*{1,10}/g, '') // ç§»é™¤æ‰€æœ‰æ˜Ÿå·
                .replace(/#{1,10}/g, '') // ç§»é™¤æ‰€æœ‰äº•å·
                .replace(/-{2,10}/g, '') // ç§»é™¤å¤šä¸ªæ¨ªçº¿
                .replace(/_{1,10}/g, '') // ç§»é™¤ä¸‹åˆ’çº¿
                .replace(/`{1,10}/g, '') // ç§»é™¤åå¼•å·
                .replace(/\|/g, '') // ç§»é™¤ç«–çº¿
                .replace(/\^/g, '') // ç§»é™¤å°–å·
                .replace(/~/g, '') // ç§»é™¤æ³¢æµªå·
                // ç§»é™¤å¤šä½™ç©ºæ ¼å’Œæ¢è¡Œ
                .replace(/\s+/g, ' ') // å¤šä¸ªç©ºæ ¼å˜æˆå•ä¸ªç©ºæ ¼
                .trim();
            
            // ç¬¬äºŒæ­¥ï¼šæ™ºèƒ½è¯†åˆ«å’Œåˆ†æ®µ
            let html = cleanText;
            
            // è¯†åˆ«é¤æ¬¡å¹¶è‡ªåŠ¨åˆ†æ®µç¾åŒ–
            html = html
                .replace(/(æ—©é¤[ï¼š:]?)/gi, '<div class="meal-section"><h3 class="meal-title">ğŸŒ… æ—©é¤</h3><div class="meal-content">')
                .replace(/(åˆé¤[ï¼š:]?)/gi, '</div></div><div class="meal-section"><h3 class="meal-title">ğŸŒ åˆé¤</h3><div class="meal-content">')
                .replace(/(æ™šé¤[ï¼š:]?)/gi, '</div></div><div class="meal-section"><h3 class="meal-title">ğŸŒ™ æ™šé¤</h3><div class="meal-content">')
                .replace(/(å®µå¤œ[ï¼š:]?)/gi, '</div></div><div class="meal-section"><h3 class="meal-title">ğŸŒœ å®µå¤œ</h3><div class="meal-content">');
            
            // è¯†åˆ«æ˜ŸæœŸå¹¶ç¾åŒ–
            html = html
                .replace(/(å‘¨[ä¸€äºŒä¸‰å››äº”å…­æ—¥å¤©æœ«]|æ˜ŸæœŸ[ä¸€äºŒä¸‰å››äº”å…­æ—¥å¤©]|ç¤¼æ‹œ[ä¸€äºŒä¸‰å››äº”å…­æ—¥å¤©])/gi, '<h2 class="day-title">ğŸ“… $1</h2>')
                .replace(/(å‘¨1|å‘¨2|å‘¨3|å‘¨4|å‘¨5|å‘¨6|å‘¨7)/gi, '<h2 class="day-title">ğŸ“… $1</h2>');
            
            // å¤„ç†ã€ã€‘æ ‡ç­¾
            html = html.replace(/ã€(.*?)ã€‘/g, '<span class="highlight-tag">$1</span>');
            
                            // è™•ç†ç‡Ÿé¤Šæˆåˆ†ï¼ˆæ•¸å­—+å–®ä½ï¼‰
            html = html.replace(/(\d+)(g|å…‹|å¡|å¤§å¡|æ¯«å…‹|mg|ml|æ¯«å‡)/gi, '<span class="nutrition-value">$1$2</span>');
            
            // å¤„ç†è¡¨æƒ…ç¬¦å·
            html = html.replace(/(ğŸ“Š|ğŸ¯|ğŸ’¡|âš ï¸|ğŸ©º|â¤ï¸|ğŸ’“|ğŸ¦´|ğŸ«˜|ğŸ©¸|âš–ï¸|ğŸ—ï¸|ğŸ§ª|ğŸ“ˆ|ğŸŒ…|ğŸŒ|ğŸŒ™|ğŸŒœ|ğŸ“…)/g, '<span class="emoji-highlight">$1</span>');
            
            // å¤„ç†é£Ÿç‰©åˆ†éš”ï¼ˆ+ å·åˆ†éš”çš„é£Ÿç‰©ï¼‰
            html = html.replace(/\s*\+\s*/g, '<span class="food-separator"> + </span>');
            
                            // è™•ç†å»ºè­°æ¸…å–®ï¼ˆä»¥ç ´æŠ˜è™Ÿæˆ–é»é–‹é ­çš„è¡Œï¼‰
            html = html.replace(/^[â€¢\-\*]\s*(.+)$/gm, '<li class="advice-item">$1</li>');
            
                            // åŒ…è£å»ºè­°æ¸…å–®
            if (html.includes('<li class="advice-item">')) {
                html = html.replace(/(<li class="advice-item">.*<\/li>)/gs, '<ul class="advice-list">$1</ul>');
            }
            
            // è‡ªåŠ¨åˆ†æ®µï¼ˆæ ¹æ®å¥å·ï¼‰
            if (!html.includes('<div class="meal-section">') && !html.includes('<h2>') && !html.includes('<ul>')) {
                html = html.replace(/([ã€‚ï¼ï¼Ÿ])\s*/g, '$1</p><p class="auto-paragraph">');
                html = '<p class="auto-paragraph">' + html + '</p>';
                // æ¸…ç†ç©ºæ®µè½
                html = html.replace(/<p class="auto-paragraph">\s*<\/p>/g, '');
            }
            
            // ç»“æŸæœªé—­åˆçš„é¤æ¬¡å®¹å™¨
            if (html.includes('<div class="meal-content">') && !html.includes('</div></div>')) {
                html += '</div></div>';
            }
            
            return html;
        }

        // æ·»åŠ èŠå¤©æ¶ˆæ¯
        function addMessage(sender, text) {
            // ğŸ›¡ï¸ é£Ÿè­œç”Ÿæˆä¿è­·ï¼šé˜»æ­¢ä»»ä½•å…§å®¹é€²å…¥èŠå¤©æ¡†
            if (isGeneratingMenu && sender === 'ai') {
                console.log('ğŸš« [PROTECT] é£Ÿè­œç”Ÿæˆä¸­ï¼Œé˜»æ­¢AIè¨Šæ¯é€²å…¥èŠå¤©æ¡†:', text.substring(0, 50));
                return;
            }
            
            const messagesContainer = document.getElementById('chat-messages');
            const message = document.createElement('div');
            message.className = `message ${sender}`;
            
            if (sender === 'ai') {
                message.innerHTML = markdownToHtml(text);
            } else {
                message.textContent = text;
            }
            
            messagesContainer.appendChild(message);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            console.log('ğŸ’¬ [CHAT] å·²æ·»åŠ èŠå¤©è¨Šæ¯:', sender, text.substring(0, 50));
        }

        // è¿½åŠ åˆ°æœ€åä¸€æ¡æ¶ˆæ¯
        function appendToLastMessage(text) {
            // ğŸ›¡ï¸ é£Ÿè­œç”Ÿæˆä¿è­·ï¼šé˜»æ­¢ä»»ä½•å…§å®¹é€²å…¥èŠå¤©æ¡†
            if (isGeneratingMenu) {
                console.log('ğŸš« [PROTECT] é£Ÿè­œç”Ÿæˆä¸­ï¼Œé˜»æ­¢å…§å®¹è¿½åŠ åˆ°èŠå¤©æ¡†:', text.substring(0, 50));
                return;
            }
            
            const messages = document.querySelectorAll('#chat-messages .message');
            if (messages.length > 0) {
                const lastMessage = messages[messages.length - 1];
                
                if (lastMessage.classList.contains('ai')) {
                    // å¯¹äºAIæ¶ˆæ¯ï¼Œç´¯ç§¯æ–‡æœ¬ç„¶åé‡æ–°æ¸²æŸ“
                    const currentText = lastMessage.getAttribute('data-raw-text') || '';
                    const newText = currentText + text;
                    lastMessage.setAttribute('data-raw-text', newText);
                    lastMessage.innerHTML = markdownToHtml(newText);
                } else {
                    lastMessage.textContent += text;
                }
                
                document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
            }
            
            console.log('ğŸ’¬ [CHAT] å·²è¿½åŠ èŠå¤©å…§å®¹:', text.substring(0, 50));
        }

        // ç¦ç”¨èŠå¤©è¾“å…¥
        function disableChatInput() {
            document.getElementById('chat-input').disabled = true;
        }

        // å¯ç”¨èŠå¤©è¾“å…¥
        function enableChatInput() {
            document.getElementById('chat-input').disabled = false;
        }

        // æ›´æ–°å€‹äººåŒ–å»ºè­° (æ™ºèƒ½åˆ¤æ–·æ˜¯å¦æœ‰é£²é£Ÿè¨˜éŒ„)
        async function updateRecommendations() {
            const recommendations = document.getElementById('recommendations');
            
            // å¦‚æœæ²’æœ‰å¡«å¯«å€‹äººè³‡è¨Š
            if (Object.keys(userProfile).length === 0) {
                recommendations.innerHTML = '<h4>ğŸ’¡ é–‹å§‹ä½¿ç”¨</h4><div class="recommendation-item">ğŸ‘‹ æ­¡è¿ä½¿ç”¨æ™ºæ…§é£²é£ŸåŠ©ç†ï¼è«‹å…ˆå¡«å¯«æ‚¨çš„å€‹äººè³‡è¨Šä»¥ç²å¾—å€‹äººåŒ–å»ºè­°ã€‚</div>';
                return;
            }
            
            // å¦‚æœå¡«å¯«äº†å€‹äººè³‡è¨Šä½†é‚„æ²’æœ‰é£²é£Ÿè¨˜éŒ„
            if (todayFood.length === 0) {
                let html = '<h4>ğŸ’¡ ä»Šæ—¥å»ºè­°</h4>';
                
                // çµ¦å‡ºåŸºæ–¼ä½¿ç”¨è€…è³‡æ–™çš„ä¸€èˆ¬å»ºè­°ï¼Œä¸æ¶‰åŠå…·é«”ç‡Ÿé¤Šæ”å–åˆ†æ
                const bmi = userProfile.bmi || userProfile.weight / Math.pow(userProfile.height / 100, 2);
                
                html += '<div class="recommendation-item">ğŸ“ è«‹é–‹å§‹è¨˜éŒ„æ‚¨ä»Šå¤©çš„é£²é£Ÿï¼Œæˆ‘å°‡ç‚ºæ‚¨æä¾›å°ˆæ¥­çš„ç‡Ÿé¤Šåˆ†æï¼</div>';
                
                // åŸºæ–¼BMIçš„ä¸€èˆ¬å¥åº·å»ºè­°
                if (bmi < 18.5) {
                    html += '<div class="recommendation-item">ğŸ“Š æ‚¨çš„BMIç‚º ' + bmi.toFixed(1) + 'ï¼Œå±¬æ–¼åç˜¦ï¼Œå»ºè­°é—œæ³¨ç‡Ÿé¤Šå‡è¡¡ã€‚</div>';
                } else if (bmi > 25) {
                    html += '<div class="recommendation-item">ğŸ“Š æ‚¨çš„BMIç‚º ' + bmi.toFixed(1) + 'ï¼Œå»ºè­°æ§åˆ¶ç†±é‡ä¸¦å¢åŠ é‹å‹•ã€‚</div>';
                } else {
                    html += '<div class="recommendation-item">ğŸ“Š æ‚¨çš„BMIç‚º ' + bmi.toFixed(1) + 'ï¼Œå±¬æ–¼æ­£å¸¸ç¯„åœï¼Œä¿æŒè‰¯å¥½ç¿’æ…£ï¼</div>';
                }
                
                html += `<div class="recommendation-item">ğŸ¯ æ‚¨çš„æ¯æ—¥ç‡Ÿé¤Šç›®æ¨™ï¼š${nutritionGoals.calories}å¡è·¯é‡Œï¼Œè›‹ç™½è³ª${nutritionGoals.protein}g</div>`;
                html += '<div class="recommendation-item">ğŸ’§ åˆ¥å¿˜äº†æ¯å¤©å–è¶³å¤ çš„æ°´ï¼Œå»ºè­°8-10æ¯ã€‚</div>';
                
                recommendations.innerHTML = html;
                return;
            }
            
            // æœ‰é£²é£Ÿè¨˜éŒ„æ™‚ï¼Œé€²è¡Œè©³ç´°çš„ç‡Ÿé¤Šåˆ†æ
            try {
                // è¨ˆç®—ç•¶å‰ç‡Ÿé¤Šæ”å–
                const consumed = todayFood.reduce((total, food) => ({
                    calories: total.calories + food.calories,
                    protein: total.protein + food.protein,
                    carbs: total.carbs + food.carbs,
                    fat: total.fat + food.fat
                }), { calories: 0, protein: 0, carbs: 0, fat: 0 });
                
                const response = await fetch('/api/recommendations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userProfile: userProfile,
                        consumedNutrition: consumed,
                        nutritionGoals: nutritionGoals
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    let html = '<h4>ğŸ’¡ ç‡Ÿé¤Šå»ºè­°</h4>';
                    
                    data.recommendations.forEach(rec => {
                        const priorityIcon = rec.priority === 'high' ? 'ğŸ”´' : 
                                           rec.priority === 'medium' ? 'ğŸŸ¡' : 'ğŸŸ¢';
                        html += `<div class="recommendation-item">${priorityIcon} ${rec.message}</div>`;
                    });
                    
                    recommendations.innerHTML = html;
                    return;
                }
            } catch (error) {
                console.error('ç²å–å»ºè­°å¤±æ•—:', error);
            }
            
            // APIå¤±æ•—æ™‚çš„æœ¬åœ°åˆ†æ
            const consumed = todayFood.reduce((total, food) => ({
                calories: total.calories + food.calories,
                protein: total.protein + food.protein,
                carbs: total.carbs + food.carbs,
                fat: total.fat + food.fat
            }), { calories: 0, protein: 0, carbs: 0, fat: 0 });
            
            let html = '<h4>ğŸ’¡ ç‡Ÿé¤Šå»ºè­°</h4>';
            
            // åŸºæ–¼å¯¦éš›æ”å–çš„åˆ†æ
            const calorieRatio = consumed.calories / nutritionGoals.calories;
            const proteinRatio = consumed.protein / nutritionGoals.protein;
            
            if (calorieRatio < 0.5) {
                html += '<div class="recommendation-item">ğŸ”´ ä»Šæ—¥ç†±é‡æ”å–åš´é‡ä¸è¶³ï¼Œè«‹é©é‡å¢åŠ å¥åº·é£Ÿç‰©ã€‚</div>';
            } else if (calorieRatio < 0.8) {
                html += '<div class="recommendation-item">ğŸŸ¡ ä»Šæ—¥ç†±é‡æ”å–åä½ï¼Œå»ºè­°å†å¢åŠ ä¸€äº›ç‡Ÿé¤Šé£Ÿç‰©ã€‚</div>';
            } else if (calorieRatio > 1.2) {
                html += '<div class="recommendation-item">ğŸŸ¡ ä»Šæ—¥ç†±é‡æ”å–è¼ƒé«˜ï¼Œæ˜å¤©æ³¨æ„æ§åˆ¶é£²é£Ÿã€‚</div>';
            } else {
                html += '<div class="recommendation-item">ğŸŸ¢ ä»Šæ—¥ç†±é‡æ”å–é©ä¸­ï¼Œå¾ˆå¥½ï¼</div>';
            }
            
            if (proteinRatio < 0.8) {
                html += '<div class="recommendation-item">ğŸŸ¡ è›‹ç™½è³ªæ”å–ä¸è¶³ï¼Œå»ºè­°å¢åŠ é›è›‹ã€é›èƒ¸è‚‰ã€é­šé¡ç­‰ã€‚</div>';
            } else {
                html += '<div class="recommendation-item">ğŸŸ¢ è›‹ç™½è³ªæ”å–å……è¶³ï¼Œç¹¼çºŒä¿æŒï¼</div>';
            }
            
            html += '<div class="recommendation-item">ğŸ’§ ç¹¼çºŒä¿æŒå……è¶³çš„æ°´åˆ†æ”å–ã€‚</div>';
            
            recommendations.innerHTML = html;
        }

        // éµç›¤äº‹ä»¶
        document.getElementById('chat-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // é£Ÿç‰©æœç´¢åŠŸèƒ½
        let searchTimeout;
        const foodNameInput = document.getElementById('food-name');
        const foodSuggestions = document.getElementById('food-suggestions');

        foodNameInput.addEventListener('input', function(e) {
            const query = e.target.value.trim();
            
            clearTimeout(searchTimeout);
            
            if (query.length < 1) {
                foodSuggestions.style.display = 'none';
                return;
            }
            
            searchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`/api/food/search/${encodeURIComponent(query)}`);
                    const data = await response.json();
                    
                    if (data.success && data.results.length > 0) {
                        let html = '';
                        data.results.forEach(food => {
                            html += `<div style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #eee;" 
                                          onmouseover="this.style.backgroundColor='#f0f0f0'" 
                                          onmouseout="this.style.backgroundColor='white'"
                                          onclick="selectFood('${food.name}')">${food.name} 
                                          <span style="color: #666; font-size: 0.9em;">(${food.nutrition.calories}å¡/100g)</span></div>`;
                        });
                        foodSuggestions.innerHTML = html;
                        foodSuggestions.style.display = 'block';
                    } else {
                        foodSuggestions.style.display = 'none';
                    }
                } catch (error) {
                    console.error('æœç´¢é£Ÿç‰©å¤±è´¥:', error);
                    foodSuggestions.style.display = 'none';
                }
            }, 300);
        });

        // é€‰æ‹©é£Ÿç‰©
        function selectFood(foodName) {
            document.getElementById('food-name').value = foodName;
            document.getElementById('food-suggestions').style.display = 'none';
            document.getElementById('food-amount').focus();
        }

                    // é»æ“Šå…¶ä»–åœ°æ–¹éš±è—å»ºè­°
        document.addEventListener('click', function(e) {
            if (!foodNameInput.contains(e.target) && !foodSuggestions.contains(e.target)) {
                foodSuggestions.style.display = 'none';
            }
        });

        // AIåŠ©æ‰‹æ°”æ³¡æ§åˆ¶
        let bubbleVisible = false;
        function toggleAssistantBubble() {
            const bubble = document.getElementById('assistantBubble');
            bubbleVisible = !bubbleVisible;
            bubble.style.display = bubbleVisible ? 'block' : 'none';
            
            // è‡ªåŠ¨éšè—
            if (bubbleVisible) {
                setTimeout(() => {
                    bubble.style.display = 'none';
                    bubbleVisible = false;
                }, 5000);
            }
        }

        // ç”Ÿæˆä¸€é€±é£Ÿè­œ
        async function generateWeeklyMenu() {
            const dietGoal = document.getElementById('diet-goal').value;
            const cuisinePreference = document.getElementById('cuisine-preference').value;
            const dislikeFoods = document.getElementById('dislike-foods').value.trim();
            const budgetRange = document.getElementById('budget-range').value;
            
            pageLog('ğŸ” [DEBUG] é–‹å§‹ç”Ÿæˆé£Ÿè­œï¼Œæª¢æŸ¥åƒæ•¸');
            pageLog('ğŸ“Š [DEBUG] é£²é£Ÿç›®æ¨™: ' + dietGoal);
            pageLog('ğŸ½ï¸ [DEBUG] é£²é£Ÿåå¥½: ' + cuisinePreference);
            pageLog('ğŸš« [DEBUG] ä¸å–œæ­¡çš„é£Ÿç‰©: ' + dislikeFoods);
            pageLog('ğŸ’° [DEBUG] é ç®—ç¯„åœ: ' + budgetRange);
            pageLog('ğŸ‘¤ [DEBUG] ç”¨æˆ¶è³‡æ–™: ' + JSON.stringify(userProfile));
            pageLog('ğŸ¯ [DEBUG] ç‡Ÿé¤Šç›®æ¨™: ' + JSON.stringify(nutritionGoals));
            
            // å¦‚æœæ²’æœ‰è¨­ç½®é£²é£Ÿç›®æ¨™ï¼Œä½¿ç”¨é è¨­å€¼
            if (!dietGoal) {
                document.getElementById('diet-goal').value = 'maintenance';
                pageLog('âš ï¸ [DEBUG] ä½¿ç”¨é»˜èªé£²é£Ÿç›®æ¨™: maintenance');
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰é£Ÿè°±
            if (weeklyMenu && weeklyMenu.content) {
                pageLog('â„¹ï¸ [DEBUG] å·²æœ‰é£Ÿè­œï¼Œæç¤ºç”¨æˆ¶');
                addMessage('ai', 'æ‚¨å·²ç¶“æœ‰ä¸€å€‹é£Ÿè­œè¨ˆç•«äº†ï¼å¦‚æœæƒ³ç”Ÿæˆæ–°çš„é£Ÿè­œï¼Œè«‹å…ˆé»æ“Š"åˆªé™¤ç›®å‰é£Ÿè­œ"æŒ‰éˆ•åˆªé™¤ç›®å‰é£Ÿè­œã€‚');
                return;
            }
            
            // è¯¦ç»†æ£€æŸ¥ç”¨æˆ·èµ„æ–™å®Œæ•´æ€§
            pageLog('ğŸ” [DEBUG] æª¢æŸ¥ç”¨æˆ¶è³‡æ–™å®Œæ•´æ€§...');
            const requiredFields = ['age', 'height', 'weight', 'gender', 'activity'];
            const missingFields = requiredFields.filter(field => !userProfile[field]);
            
            if (Object.keys(userProfile).length === 0 || missingFields.length > 0) {
                pageLog('âŒ [DEBUG] ç”¨æˆ¶è³‡æ–™ä¸å®Œæ•´ï¼Œç¼ºå°‘: ' + missingFields.join(', '));
                const weeklyMenuDiv = document.getElementById('weekly-menu-table');
                weeklyMenuDiv.innerHTML = `
                    <div class="empty-menu-table">
                        ğŸ“ è«‹å…ˆå®Œå–„æ‚¨çš„å€‹äººä¿¡æ¯<br>
                        <small style="color: #666; margin-top: 8px; display: block;">
                            ç¼ºå°‘ï¼š${missingFields.length > 0 ? missingFields.join('ã€') : 'åŸºæœ¬è³‡æ–™'}<br>
                            è«‹å¡«å¯«å¹´é½¡ã€èº«é«˜ã€é«”é‡ã€æ€§åˆ¥ã€æ´»å‹•æ°´å¹³å¾Œé‡è©¦
                        </small>
                    </div>
                `;
                return;
            }
            
            // æª¢æŸ¥ç‡Ÿé¤Šç›®æ¨™
            if (!nutritionGoals || !nutritionGoals.calories) {
                pageLog('âŒ [DEBUG] ç‡Ÿé¤Šç›®æ¨™æœªè¨ˆç®—');
                const weeklyMenuDiv = document.getElementById('weekly-menu-table');
                weeklyMenuDiv.innerHTML = `
                    <div class="empty-menu-table">
                        âš ï¸ ç‡Ÿé¤Šç›®æ¨™è¨ˆç®—ç•°å¸¸<br>
                        <small style="color: #666; margin-top: 8px; display: block;">
                            è«‹é‡æ–°ä¿å­˜å€‹äººä¿¡æ¯æˆ–åˆ·æ–°é é¢é‡è©¦
                        </small>
                    </div>
                `;
                return;
            }
            
            pageLog('âœ… [DEBUG] æ‰€æœ‰æª¢æŸ¥é€šéï¼Œé–‹å§‹ç”Ÿæˆé£Ÿè­œ');
            
            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            const weeklyMenuDiv = document.getElementById('weekly-menu-table');
            weeklyMenuDiv.innerHTML = `
                <div class="generating-menu">
                    <div class="spinner"></div>
                    <div>ğŸ¤– AIæ­£åœ¨ç‚ºæ‚¨ç²¾å¿ƒåˆ¶å®šä¸€é€±é£Ÿè­œ...</div>
                    <div style="font-size: 0.9rem; margin-top: 10px; opacity: 0.8;">
                        â±ï¸ æ ¹æ“šæ‚¨çš„å¥åº·ç‹€æ³å’Œé£²é£Ÿåå¥½å®¢è£½åŒ–ä¸­<br>
                        ğŸ“‹ ç”Ÿæˆçš„é£Ÿè­œå°‡é¡¯ç¤ºåœ¨ä¸‹æ–¹è¡¨æ ¼ä¸­
                    </div>
                </div>
            `;
            
            // åœç”¨ç”ŸæˆæŒ‰éˆ•
            document.getElementById('generate-menu-btn').disabled = true;
            document.getElementById('generate-menu-btn').textContent = 'ç”Ÿæˆä¸­...';
            
            // æ§‹å»ºé£Ÿè­œç”Ÿæˆçš„prompt
            const menuPrompt = buildMenuPrompt(dietGoal, cuisinePreference, dislikeFoods, budgetRange);
            
            try {
                // ğŸ›¡ï¸ å¼·åˆ¶è¨­ç½®é£Ÿè­œç”Ÿæˆæ¨¡å¼ï¼Œå®Œå…¨é˜»æ–·èŠå¤©
                pageLog('ğŸš€ [GENERATE] å•Ÿå‹•é£Ÿè­œç”Ÿæˆæ¨¡å¼');
                isGeneratingMenu = true;
                currentMenuText = '';
                
                // ğŸ“¤ ç™¼é€é£Ÿè­œç”Ÿæˆè«‹æ±‚
                pageLog('ğŸ“¤ [GENERATE] ç™¼é€WebSocketè«‹æ±‚ï¼ŒrequestType: weekly-menu');
                pageLog('ğŸ“ [GENERATE] Prompté•·åº¦: ' + menuPrompt.length);
                pageLog('ğŸ“„ [GENERATE] Promptå…§å®¹é è¦½: ' + menuPrompt.substring(0, 200) + '...');
                
                // ğŸ” æª¢æŸ¥WebSocketé€£æ¥ç‹€æ…‹
                if (ws.readyState !== WebSocket.OPEN) {
                    pageLog('âŒ [GENERATE] WebSocketæœªé€£æ¥ï¼Œç•¶å‰ç‹€æ…‹: ' + ws.readyState);
                    const statusMap = {
                        0: 'CONNECTING',
                        1: 'OPEN', 
                        2: 'CLOSING',
                        3: 'CLOSED'
                    };
                    throw new Error(`WebSocketé€£æ¥ç•°å¸¸ï¼ˆ${statusMap[ws.readyState] || ws.readyState}ï¼‰ï¼Œè«‹åˆ·æ–°é é¢é‡è©¦`);
                }
                
                const requestData = { 
                    prompt: menuPrompt, 
                    requestType: 'weekly-menu'
                };
                
                pageLog('ğŸ“¨ [GENERATE] æº–å‚™ç™¼é€çš„è«‹æ±‚æ•¸æ“š: promptLength=' + requestData.prompt.length + ', requestType=' + requestData.requestType + ', wsState=' + ws.readyState);
                
                ws.send(JSON.stringify(requestData));
                
                pageLog('âœ… [GENERATE] é£Ÿè­œè«‹æ±‚å·²ç™¼é€ï¼Œç­‰å¾…å›æ‡‰...');
                
                // â° è¨­ç½®è¶…æ™‚ä¿è­·ï¼ˆ60ç§’ï¼‰
                const timeoutId = setTimeout(() => {
                    if (isGeneratingMenu) {
                        pageLog('âš ï¸ [TIMEOUT] é£Ÿè­œç”Ÿæˆè¶…æ™‚ï¼ˆ60ç§’ï¼‰ï¼Œé‡ç½®ç‹€æ…‹');
                        isGeneratingMenu = false;
                        weeklyMenuDiv.innerHTML = `
                            <div class="empty-menu-table">
                                â° é£Ÿè­œç”Ÿæˆè¶…æ™‚<br>
                                <small style="color: #666; margin-top: 8px; display: block;">
                                    ç­‰å¾…æ™‚é–“è¶…é60ç§’ï¼Œå¯èƒ½åŸå› ï¼š<br>
                                    â€¢ æœå‹™å™¨ç„¡å›æ‡‰<br>
                                    â€¢ ç¶²è·¯é€£æ¥å•é¡Œ<br>
                                    â€¢ AIæœå‹™ç•°å¸¸<br>
                                    <br>
                                    å»ºè­°åˆ·æ–°é é¢é‡è©¦
                                </small>
                                <button onclick="location.reload()" style="margin-top: 10px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    ğŸ”„ åˆ·æ–°é é¢
                                </button>
                            </div>
                        `;
                        resetMenuButtons();
                    }
                }, 60000); // 60ç§’è¶…æ™‚
                
                pageLog('â° [TIMEOUT] è¨­ç½®60ç§’è¶…æ™‚ä¿è­·');
                
            } catch (error) {
                console.error('âŒ [GENERATE] ç”Ÿæˆé£Ÿè­œå¤±æ•—:', error);
                
                // ğŸ”„ å˜—è©¦å‚™ç”¨æ–¹æ¡ˆï¼šç°¡åŒ–ç‰ˆé£Ÿè­œç”Ÿæˆ
                pageLog('ğŸ”„ [FALLBACK] å˜—è©¦ä½¿ç”¨ç°¡åŒ–ç‰ˆé£Ÿè­œç”Ÿæˆ...');
                try {
                    const simplePrompt = buildSimpleMenuPrompt();
                    pageLog('ğŸ“¤ [FALLBACK] ç™¼é€ç°¡åŒ–ç‰ˆè«‹æ±‚');
                    
                    if (ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({ 
                            prompt: simplePrompt, 
                            requestType: 'weekly-menu'
                        }));
                        pageLog('âœ… [FALLBACK] ç°¡åŒ–ç‰ˆè«‹æ±‚å·²ç™¼é€');
                        return; // ä¸è¦é‡ç½®ç‹€æ…‹ï¼Œç­‰å¾…å›æ‡‰
                    }
                } catch (fallbackError) {
                    pageLog('âŒ [FALLBACK] å‚™ç”¨æ–¹æ¡ˆä¹Ÿå¤±æ•—: ' + fallbackError);
                }
                
                // æ‰€æœ‰æ–¹æ¡ˆéƒ½å¤±æ•—ï¼Œé‡ç½®ç‹€æ…‹ä¸¦é¡¯ç¤ºéŒ¯èª¤
                isGeneratingMenu = false;
                weeklyMenuDiv.innerHTML = `
                    <div class="empty-menu-table">
                        âŒ é£Ÿè­œç”Ÿæˆå¤±æ•—<br>
                        <small style="color: #666; margin-top: 8px; display: block;">
                            éŒ¯èª¤ï¼š${error.message}<br>
                            <br>
                            ğŸ”§ <strong>è§£æ±ºæ–¹æ¡ˆï¼š</strong><br>
                            1. æª¢æŸ¥æ˜¯å¦å·²å¡«å¯«å®Œæ•´å€‹äººä¿¡æ¯<br>
                            2. åˆ·æ–°é é¢é‡è©¦ï¼ˆCtrl + F5ï¼‰<br>
                            3. æª¢æŸ¥ç¶²è·¯é€£æ¥ç‹€æ…‹<br>
                            4. ç¨å¾Œå†è©¦
                        </small>
                        <button onclick="location.reload()" style="margin-top: 10px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            ğŸ”„ åˆ·æ–°é é¢
                        </button>
                    </div>
                `;
                resetMenuButtons();
            }
        }

        // æ§‹å»ºé£Ÿè­œç”Ÿæˆçš„prompt
        function buildMenuPrompt(dietGoal, cuisinePreference, dislikeFoods, budgetRange) {
            pageLog('ğŸ”§ [PROMPT] é–‹å§‹æ§‹å»ºé£Ÿè­œç”ŸæˆPrompt');
            
            // å®‰å…¨ç²å–ç”¨æˆ¶è³‡æ–™ï¼Œé¿å…undefinedéŒ¯èª¤
            const age = userProfile.age || 25;
            const gender = userProfile.gender || 'male';
            const height = userProfile.height || 170;
            const weight = userProfile.weight || 65;
            const activity = userProfile.activity || 'moderate';
            const calories = nutritionGoals?.calories || 1800;
            const protein = nutritionGoals?.protein || 90;
            
            pageLog('ğŸ“Š [PROMPT] ä½¿ç”¨çš„è³‡æ–™: age=' + age + ', gender=' + gender + ', height=' + height + ', weight=' + weight + ', activity=' + activity + ', calories=' + calories + ', protein=' + protein);
            
            let context = `ä½ æ˜¯å°ˆæ¥­ç‡Ÿé¤Šå¸«ï¼Œè«‹ç‚ºä½¿ç”¨è€…åˆ¶å®šä¸€é€±å®Œæ•´çš„ä¸‰é¤é£Ÿè­œè¨ˆç•«ã€‚

ã€é‡è¦ã€‘è«‹ä½¿ç”¨ç¹é«”ä¸­æ–‡å›ç­”ï¼Œä¸¦ä½¿ç”¨å°ç£çš„é£Ÿç‰©ç”¨è©ï¼ˆä¾‹å¦‚ï¼šç•ªèŒ„è€Œéè¥¿ç´…æŸ¿ã€ç´…è˜¿è””è€Œéèƒ¡è˜¿è””ã€é¦¬éˆ´è–¯è€ŒéåœŸè±†ç­‰ï¼‰ã€‚

ã€ä½¿ç”¨è€…è³‡è¨Šã€‘
å¹´é½¡ï¼š${age}æ­²
æ€§åˆ¥ï¼š${gender === 'male' ? 'ç”·' : 'å¥³'}
èº«é«˜ï¼š${height}cm
é«”é‡ï¼š${weight}kg
æ´»å‹•æ°´å¹³ï¼š${getActivityLabel(activity)}
æ¯æ—¥ç‡Ÿé¤Šç›®æ¨™ï¼š${calories}å¡è·¯é‡Œï¼Œè›‹ç™½è³ª${protein}g

ã€å¥åº·ç‹€æ³ã€‘`;

            if (userProfile.medicalConditions && userProfile.medicalConditions.trim()) {
                context += `\nç‰¹æ®Šç–¾ç—…ï¼š${userProfile.medicalConditions}`;
            }
            if (userProfile.allergies && userProfile.allergies.trim()) {
                context += `\néæ•åŸï¼š${userProfile.allergies}`;
            }

            context += `\n
ã€é£²é£Ÿè¦æ±‚ã€‘
ç›®æ¨™ï¼š${getDietGoalLabel(dietGoal)}
é£²é£Ÿåå¥½ï¼š${getCuisineLabel(cuisinePreference)}
é ç®—ç¯„åœï¼š${getBudgetLabel(budgetRange)}`;

            if (dislikeFoods) {
                context += `\nä¸å–œæ­¡çš„é£Ÿç‰©ï¼š${dislikeFoods}`;
            }

            context += `\n
ã€æ ¼å¼è¦æ±‚ã€‘
è«‹æŒ‰ä»¥ä¸‹æ ¼å¼æä¾›ä¸€é€±é£Ÿè­œï¼š

é€±ä¸€ ç¸½è¨ˆç´„1800å¡
æ—©é¤ï¼šç‡•éº¥ç²¥ + æ°´ç…®è›‹ + ç‰›å¥¶ (ç´„400å¡ï¼Œè›‹ç™½è³ª18g)
åˆé¤ï¼šé›èƒ¸è‚‰æ²™æ‹‰ + å…¨éº¥éºµåŒ… + è˜‹æœ (ç´„600å¡ï¼Œè›‹ç™½è³ª35g)  
æ™šé¤ï¼šæ¸…è’¸é­š + è’¸è›‹ + é’èœ (ç´„500å¡ï¼Œè›‹ç™½è³ª30g)

ã€é‡è¦è¦æ±‚ã€‘
1. åš´æ ¼é¿å…ä½¿ç”¨è€…éæ•çš„é£Ÿç‰©
2. æ ¹æ“šç‰¹æ®Šç–¾ç—…èª¿æ•´é£Ÿè­œï¼ˆå¦‚ç³–å°¿ç—…é¿å…é«˜ç³–ï¼Œé«˜è¡€å£“å°‘é¹½ç­‰ï¼‰
3. æ¯æ—¥ç‡Ÿé¤Šå‡è¡¡ï¼Œæ»¿è¶³ç›®æ¨™éœ€æ±‚
4. é£Ÿç‰©æ­é…å¤šæ¨£åŒ–ï¼Œé¿å…é‡è¤‡
5. è€ƒæ…®é ç®—é™åˆ¶ï¼Œæ¨è–¦æ€§åƒ¹æ¯”é«˜çš„é£Ÿæ
6. æä¾›å…·é«”çš„é£Ÿç‰©åˆ†é‡å’Œç‡Ÿé¤Šä¼°ç®—
7. æ¯å¤©å®‰æ’ä¸åŒå£å‘³ï¼Œä¿æŒé£²é£Ÿè¶£å‘³æ€§
8. ä½¿ç”¨å°ç£å¸¸è¦‹çš„é£Ÿæå’Œæ–™ç†æ–¹å¼
9. å¿…é ˆä½¿ç”¨ç¹é«”ä¸­æ–‡å’Œå°ç£ç”¨è©

è«‹é–‹å§‹åˆ¶å®šä¸€é€±é£Ÿè­œï¼š`;

            pageLog('âœ… [PROMPT] Promptæ§‹å»ºå®Œæˆï¼Œç¸½é•·åº¦: ' + context.length);
            pageLog('ğŸ“„ [PROMPT] Prompté è¦½: ' + context.substring(0, 200) + '...');
            
            return context;
        }
        
        // ç°¡åŒ–ç‰ˆé£Ÿè­œç”Ÿæˆï¼ˆå‚™ç”¨æ–¹æ¡ˆï¼‰
        function buildSimpleMenuPrompt() {
            pageLog('ğŸ”„ [FALLBACK] ä½¿ç”¨ç°¡åŒ–Prompt');
            return `ã€é‡è¦ã€‘è«‹ä½¿ç”¨ç¹é«”ä¸­æ–‡å›ç­”ï¼Œä¸¦ä½¿ç”¨å°ç£çš„é£Ÿç‰©ç”¨è©ï¼ˆä¾‹å¦‚ï¼šç•ªèŒ„è€Œéè¥¿ç´…æŸ¿ã€ç´…è˜¿è””è€Œéèƒ¡è˜¿è””ã€é¦¬éˆ´è–¯è€ŒéåœŸè±†ç­‰ï¼‰ã€‚

è«‹ç‚ºä¸€å€‹æˆå¹´äººåˆ¶å®šä¸€é€±å¥åº·é£Ÿè­œï¼ŒåŒ…å«æ—©é¤ã€åˆé¤ã€æ™šé¤ã€‚

æ ¼å¼è¦æ±‚ï¼š
é€±ä¸€ ç¸½è¨ˆç´„1800å¡
æ—©é¤ï¼šé£Ÿç‰©1 + é£Ÿç‰©2 (ç´„400å¡)
åˆé¤ï¼šé£Ÿç‰©1 + é£Ÿç‰©2 (ç´„700å¡)
æ™šé¤ï¼šé£Ÿç‰©1 + é£Ÿç‰©2 (ç´„500å¡)

è«‹ä½¿ç”¨å°ç£å¸¸è¦‹é£Ÿæï¼Œæä¾›ä¸€é€±7å¤©çš„å®Œæ•´é£Ÿè­œï¼Œå‹™å¿…ä½¿ç”¨ç¹é«”ä¸­æ–‡ã€‚`;
        }

        // å–å¾—æ´»å‹•æ°´å¹³æ¨™ç±¤
        function getActivityLabel(activity) {
            const labels = {
                'sedentary': 'ä¹…åå°‘å‹•',
                'light': 'è¼•åº¦æ´»å‹•',
                'moderate': 'ä¸­åº¦æ´»å‹•',
                'high': 'é«˜å¼·åº¦æ´»å‹•',
                'very_high': 'æ¥µé«˜å¼·åº¦æ´»å‹•'
            };
            return labels[activity] || activity;
        }

        // å–å¾—é£²é£Ÿç›®æ¨™æ¨™ç±¤
        function getDietGoalLabel(goal) {
            const labels = {
                'weight-loss': 'æ¸›è„‚ç˜¦èº«',
                'weight-gain': 'å¢é‡å¢è‚Œ',
                'maintenance': 'ç¶­æŒé«”é‡',
                'muscle-gain': 'å¢è‚Œå¡‘å½¢',
                'health-recovery': 'ç–¾ç—…èª¿ç†'
            };
            return labels[goal] || goal;
        }

        // å–å¾—é£²é£Ÿåå¥½æ¨™ç±¤
        function getCuisineLabel(cuisine) {
            const labels = {
                'balanced': 'å‡è¡¡é£²é£Ÿ',
                'chinese': 'ä¸­å¼æ–™ç†',
                'western': 'è¥¿å¼æ–™ç†',
                'vegetarian': 'ç´ é£Ÿä¸»ç¾©',
                'mediterranean': 'åœ°ä¸­æµ·é£²é£Ÿ',
                'ketogenic': 'ç”Ÿé…®é£²é£Ÿ',
                'low-carb': 'ä½ç¢³é£²é£Ÿ'
            };
            return labels[cuisine] || cuisine;
        }

        // å–å¾—é ç®—æ¨™ç±¤
        function getBudgetLabel(budget) {
            const labels = {
                'low': 'ç¶“æ¿Ÿå¯¦æƒ ï¼ˆæ¯æ—¥30-50å…ƒï¼‰',
                'medium': 'ä¸­ç­‰é ç®—ï¼ˆæ¯æ—¥50-100å…ƒï¼‰',
                'high': 'è¼ƒé«˜é ç®—ï¼ˆæ¯æ—¥100-200å…ƒï¼‰',
                'premium': 'ç²¾ç·»é£²é£Ÿï¼ˆæ¯æ—¥200å…ƒä»¥ä¸Šï¼‰'
            };
            return labels[budget] || budget;
        }

        // è™•ç†ä¸€é€±é£Ÿè­œçš„WebSocketéŸ¿æ‡‰
        function handleWeeklyMenuResponse(text) {
            pageLog('ğŸ½ï¸ [HANDLER] é–‹å§‹è™•ç†ä¸€é€±é£Ÿè­œéŸ¿æ‡‰ï¼Œå…§å®¹é•·åº¦: ' + text.length);
            pageLog('ğŸ“„ [HANDLER] å…§å®¹é è¦½: ' + text.substring(0, 200) + '...');
            
            const weeklyMenuDiv = document.getElementById('weekly-menu-table');
            
            if (!weeklyMenuDiv) {
                console.error('âŒ æ‰¾ä¸åˆ°weekly-menu-tableå…ƒç´ ï¼');
                return;
            }
            
            // ç¢ºä¿ä¸ç‚ºç©º
            if (!text || text.trim().length === 0) {
                console.log('âŒ é£Ÿè­œå…§å®¹ç‚ºç©º');
                weeklyMenuDiv.innerHTML = `
                    <div class="empty-menu-table">
                        âŒ é£Ÿè­œç”Ÿæˆå¤±æ•—ï¼Œè«‹é‡è©¦
                    </div>
                `;
                resetMenuButtons();
                return;
            }
            
            console.log('ğŸ“Š é–‹å§‹è§£æé£Ÿè­œæ–‡å­—ç‚ºè¡¨æ ¼æ ¼å¼');
            
            // å„ªå…ˆå˜—è©¦æ­£å¸¸è§£æï¼Œå¤±æ•—å‰‡å¼·åˆ¶è¡¨æ ¼ç”Ÿæˆ
            let formattedTable;
            try {
                formattedTable = parseWeeklyMenuToTable(text);
                // å¦‚æœè§£æçµæœæ˜¯ç°¡å–®æ–‡å­—å±•ç¤ºï¼Œå‰‡æ”¹ç”¨å¼·åˆ¶è¡¨æ ¼ç”Ÿæˆ
                if (formattedTable.includes('AIç”Ÿæˆçš„ä¸€é€±é£Ÿè­œ')) {
                    pageLog('ğŸ“Š æ­£å¸¸è§£æè¿”å›ç°¡å–®æ ¼å¼ï¼Œæ”¹ç”¨å¼·åˆ¶è¡¨æ ¼ç”Ÿæˆ');
                    formattedTable = forceTableGeneration(text);
                }
            } catch (error) {
                pageLog('âŒ è§£æå¤±æ•—ï¼Œä½¿ç”¨å¼·åˆ¶è¡¨æ ¼ç”Ÿæˆ: ' + error);
                formattedTable = forceTableGeneration(text);
            }
            
            console.log('ğŸ“‹ è¡¨æ ¼ç”Ÿæˆå®Œæˆï¼Œæº–å‚™é¡¯ç¤ºåœ¨"æˆ‘çš„ä¸€é€±é£Ÿè­œ"æ¨¡çµ„ä¸­');
            
            // é¡¯ç¤ºåœ¨ä¸€é€±é£Ÿè­œæ¨¡çµ„ä¸­
            weeklyMenuDiv.innerHTML = formattedTable;
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            const menuData = {
                content: text,
                timestamp: Date.now(),
                preferences: {
                    dietGoal: document.getElementById('diet-goal').value,
                    cuisinePreference: document.getElementById('cuisine-preference').value,
                    dislikeFoods: document.getElementById('dislike-foods').value,
                    budgetRange: document.getElementById('budget-range').value
                }
            };
            localStorage.setItem('weeklyMenu', JSON.stringify(menuData));
            weeklyMenu = menuData;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€ - æ˜¾ç¤ºæˆåŠŸçŠ¶æ€
            document.getElementById('generate-menu-btn').style.display = 'none';
            document.getElementById('clear-menu-btn').style.display = 'inline-block';
            
            // æ·»åŠ é”å®šæ ·å¼
            weeklyMenuDiv.classList.add('menu-locked');
            
            pageLog('âœ… [HANDLER] ä¸€é€±é£Ÿè­œå·²æˆåŠŸé¡¯ç¤ºåœ¨"æˆ‘çš„ä¸€é€±é£Ÿè­œ"æ¨¡çµ„ä¸­ï¼');
            
            // ğŸ”“ é‡è¦ï¼šé‡ç½®é£Ÿè­œç”Ÿæˆç‹€æ…‹ï¼Œæ¢å¾©èŠå¤©åŠŸèƒ½
            isGeneratingMenu = false;
            pageLog('ğŸ”“ [HANDLER] é£Ÿè­œç”Ÿæˆå®Œæˆï¼Œæ¢å¾©èŠå¤©åŠŸèƒ½');
            
            // æ»šåŠ¨åˆ°é£Ÿè°±åŒºåŸŸï¼Œè®©ç”¨æˆ·çœ‹åˆ°ç»“æœ
            weeklyMenuDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // è§£æä¸€é€±é£Ÿè­œæ–‡å­—ä¸¦æ ¼å¼åŒ–ç‚ºè¡¨æ ¼
        function parseWeeklyMenuToTable(text) {
            console.log('ğŸ” é–‹å§‹è§£æé£Ÿè­œæ–‡å­—:', text.substring(0, 300) + '...');
            
            const days = ['é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­', 'é€±æ—¥'];
            const meals = ['æ—©é¤', 'åˆé¤', 'æ™šé¤'];
            
            // è§£æé£Ÿè­œè³‡æ–™
            const menuData = {};
            // æ”¯æ´å¤šç¨®æ—¥æœŸæ ¼å¼çš„åˆ†å‰²
            const daysSplit = text.split(/(?=[é€±å‘¨][ä¸€äºŒä¸‰å››äº”å…­æ—¥å¤©])/);
            
            console.log('ğŸ“… åˆ†å‰²å¾Œçš„å¤©æ•¸:', daysSplit.length);
            
            daysSplit.forEach((dayText, index) => {
                if (!dayText.trim()) {
                    console.log(`âŒ ç¬¬${index}å¤©çš„å…§å®¹ç‚ºç©º`);
                    return;
                }
                
                console.log(`ğŸ“ è™•ç†ç¬¬${index}å¤©:`, dayText.substring(0, 200) + '...');
                
                // æ›´å¯¬é¬†çš„æ—¥æœŸåŒ¹é…æ¨¡å¼ï¼Œæ”¯æ´ç¹é«”ä¸­æ–‡
                const dayMatch = dayText.match(/([é€±å‘¨][ä¸€äºŒä¸‰å››äº”å…­æ—¥å¤©]|æ˜ŸæœŸ[ä¸€äºŒä¸‰å››äº”å…­æ—¥å¤©]|ç¦®æ‹œ[ä¸€äºŒä¸‰å››äº”å…­æ—¥å¤©])/);
                if (!dayMatch) {
                    console.log(`âŒ ç¬¬${index}å¤©ç„¡æ³•åŒ¹é…æ—¥æœŸ:`, dayText.substring(0, 100));
                    return;
                }
                
                let dayName = dayMatch[1];
                // çµ±ä¸€è½‰æ›ç‚ºé€±æ ¼å¼
                if (dayName.startsWith('å‘¨')) {
                    dayName = dayName.replace('å‘¨', 'é€±');
                }
                
                // æ›´å¯¬é¬†çš„å¡è·¯é‡ŒåŒ¹é…
                const calorieMatch = dayText.match(/(\d+)\s*[å¡åƒ]?[è·¯é‡Œ]?[é‡Œå¡]?/);
                const totalCalories = calorieMatch ? calorieMatch[1] : '0';
                
                console.log(`âœ… æ‰¾åˆ°${dayName}, ç¸½è¨ˆ${totalCalories}å¡`);
                
                menuData[dayName] = { totalCalories, meals: {} };
                
                // æå–ä¸‰é¤è³‡è¨Š - æ›´å¯¬é¬†çš„åŒ¹é…
                meals.forEach(mealName => {
                    console.log(`ğŸ½ï¸ è§£æ${dayName}çš„${mealName}`);
                    
                    // æ›´å¯¬é¬†çš„ä¸‰é¤åŒ¹é…æ¨¡å¼
                    const patterns = [
                        `ğŸ½ï¸\\s*${mealName}[ï¼š:]\\s*([^\\nğŸ½ï¸]+)`,  // ğŸ½ï¸ æ—©é¤ï¼šé£Ÿç‰©
                        `${mealName}[ï¼š:]\\s*([^\\nğŸ½ï¸]+)`,        // æ—©é¤ï¼šé£Ÿç‰©
                        `${mealName}\\s*[ï¼š:]?\\s*([^\\nğŸ½ï¸]+)`,   // å¯¬é¬†æ ¼å¼
                        `${mealName}[ï¼šï¼š]\\s*([^\\nğŸ½ï¸]*)`        // è™•ç†ä¸­æ–‡å†’è™Ÿ
                    ];
                    
                    let mealMatch = null;
                    let mealContent = '';
                    
                    for (let pattern of patterns) {
                        const regex = new RegExp(pattern, 'i');
                        mealMatch = dayText.match(regex);
                        if (mealMatch) {
                            mealContent = mealMatch[1].trim();
                            console.log(`âœ… ${mealName}åŒ¹é…æˆåŠŸ:`, mealContent.substring(0, 50));
                            break;
                        }
                    }
                    
                    if (mealContent) {
                        // æå–ç‡Ÿé¤Šè³‡è¨Š - æ›´å¯¬é¬†çš„åŒ¹é…
                        const nutritionPatterns = [
                            /\(([^)]*[å¡åƒ][^)]*)\)/,          // (ç´„200å¡)
                            /ï¼ˆ([^ï¼‰]*[å¡åƒ][^ï¼‰]*)ï¼‰/,          // ä¸­æ–‡æ‹¬è™Ÿ
                            /[ç´„çº¦]?\s*(\d+)\s*[å¡åƒ]/,       // ç´„200å¡
                            /(\d+)\s*å¤§?å¡/,                 // 200å¤§å¡
                            /å…±[ç´„çº¦]\s*(\d+[å¡åƒ][^ï¼Œã€]*)/,   // å…±ç´„200å¡
                            /\([å…±ç´„çº¦]*([^)]*[å¡åƒ][^)]*)\)/   // (å…±ç´„200å¡ï¼Œè›‹ç™½è³ª20g)
                        ];
                        
                        let nutritionInfo = '';
                        for (let pattern of nutritionPatterns) {
                            const nutritionMatch = mealContent.match(pattern);
                            if (nutritionMatch) {
                                nutritionInfo = nutritionMatch[1] || nutritionMatch[0];
                                break;
                            }
                        }
                        
                        // ç§»é™¤ç‡Ÿé¤Šè³‡è¨Šï¼Œåªä¿ç•™é£Ÿç‰©
                        const foods = mealContent
                            .replace(/\([^)]*\)/g, '')          // ç§»é™¤åœ“æ‹¬è™Ÿ
                            .replace(/ï¼ˆ[^ï¼‰]*ï¼‰/g, '')          // ç§»é™¤ä¸­æ–‡æ‹¬è™Ÿ
                            .replace(/[ç´„çº¦]?\s*\d+\s*[å¡åƒ][è·¯é‡Œ]?/g, '') // ç§»é™¤å¡è·¯é‡Œ
                            .replace(/å…±[ç´„çº¦]\s*\d+[å¡åƒ][^ï¼Œã€]*/g, '')   // ç§»é™¤å…±ç´„...å¡
                            .trim();
                        
                        menuData[dayName].meals[mealName] = {
                            foods: foods || 'æš«ç„¡å®‰æ’',
                            nutrition: nutritionInfo
                        };
                        
                        console.log(`ğŸ“ ${dayName}-${mealName}: é£Ÿç‰©="${foods}" ç‡Ÿé¤Š="${nutritionInfo}"`);
                    } else {
                        console.log(`âŒ ${dayName}çš„${mealName}æœªæ‰¾åˆ°åŒ¹é…å…§å®¹`);
                        menuData[dayName].meals[mealName] = {
                            foods: 'æš«ç„¡å®‰æ’',
                            nutrition: ''
                        };
                    }
                });
            });
            
            // ç”Ÿæˆè¡¨æ ¼HTML
            console.log('ğŸ“Š è§£æå®Œæˆï¼Œå…±æ‰¾åˆ°', Object.keys(menuData).length, 'å¤©çš„é£Ÿè­œè³‡æ–™');
            console.log('ğŸ“‹ é£Ÿè­œè³‡æ–™è©³æƒ…:', menuData);
            
            // å¦‚æœæ­£å¸¸è§£æå¤±æ•—ï¼Œå˜—è©¦å¼·åˆ¶è¡¨æ ¼è§£æ
            if (Object.keys(menuData).length === 0) {
                console.log('âŒ æ¨™æº–è§£æå¤±æ•—ï¼Œå˜—è©¦å¼·åˆ¶è¡¨æ ¼è§£æ');
                return forceTableGeneration(text);
            }
            
            let html = `
                <table class="menu-table">
                    <thead>
                        <tr>
                            <th style="width: 12%;">æ—¥æœŸ</th>
                            <th style="width: 29%;">ğŸŒ… æ—©é¤</th>
                            <th style="width: 29%;">ğŸŒ åˆé¤</th>
                            <th style="width: 29%;">ğŸŒ™ æ™šé¤</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            days.forEach(day => {
                if (menuData[day]) {
                    const dayData = menuData[day];
                    
                    html += `<tr>`;
                    html += `<td class="day-column">${day}</td>`;
                    
                    meals.forEach(meal => {
                        const mealData = dayData.meals[meal] || { foods: 'æš‚æ— å®‰æ’', nutrition: '' };
                        html += `
                            <td>
                                <div class="meal-content">
                                    <div class="meal-foods">${mealData.foods}</div>
                                    ${mealData.nutrition ? `<div class="meal-nutrition">${mealData.nutrition}</div>` : ''}
                                </div>
                            </td>
                        `;
                    });
                    
                    html += `</tr>`;
                }
            });
            
            // æ–°å¢å¡è·¯é‡Œç¸½è¨ˆè¡Œ - åªç‚ºæœ‰è³‡æ–™çš„å¤©æ•¸æ–°å¢
            const validDays = Object.keys(menuData).filter(day => days.includes(day));
            if (validDays.length > 0) {
                // ç‚ºæ¯å€‹æœ‰è³‡æ–™çš„å¤©æ–°å¢å¡è·¯é‡Œè¡Œ
                validDays.forEach(day => {
                    html += `<tr class="calories-row">`;
                    html += `<td><strong>${day}ç¸½è¨ˆ</strong></td>`;
                    html += `<td colspan="3"><strong>ç´„${menuData[day].totalCalories}å¡è·¯é‡Œ</strong></td>`;
                    html += `</tr>`;
                });
            }
            
            html += `</tbody></table>`;
            
            console.log('âœ… é£Ÿè­œè¡¨æ ¼HTMLç”Ÿæˆå®Œæˆï¼Œæº–å‚™é¡¯ç¤ºåœ¨"æˆ‘çš„ä¸€é€±é£Ÿè­œ"æ¨¡çµ„ä¸­');
            
            return html;
        }

        // å¼·åˆ¶è¡¨æ ¼ç”Ÿæˆå‡½æ•¸ - å³ä½¿è§£æå¤±æ•—ä¹Ÿè¦ç”Ÿæˆè¡¨æ ¼
        function forceTableGeneration(text) {
            console.log('ğŸ”§ å¼·åˆ¶è¡¨æ ¼ç”Ÿæˆæ¨¡å¼');
            
            const days = ['é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­', 'é€±æ—¥'];
            const meals = ['æ—©é¤', 'åˆé¤', 'æ™šé¤'];
            
            // ç°¡å–®åˆ†å‰²æ–‡æœ¬
            const lines = text.split('\n').filter(line => line.trim());
            
            let html = `
                <table class="menu-table">
                    <thead>
                        <tr>
                            <th style="width: 12%;">æ—¥æœŸ</th>
                            <th style="width: 29%;">ğŸŒ… æ—©é¤</th>
                            <th style="width: 29%;">ğŸŒ åˆé¤</th>
                            <th style="width: 29%;">ğŸŒ™ æ™šé¤</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            let currentDay = '';
            let currentMeals = { 'æ—©é¤': '', 'åˆé¤': '', 'æ™šé¤': '' };
            let totalCalories = '';
            
            lines.forEach(line => {
                // æª¢æŸ¥æ˜¯å¦æ˜¯æ—¥æœŸè¡Œ
                const dayMatch = line.match(/([é€±å‘¨][ä¸€äºŒä¸‰å››äº”å…­æ—¥å¤©]|æ˜ŸæœŸ[ä¸€äºŒä¸‰å››äº”å…­æ—¥å¤©])/);
                if (dayMatch) {
                    // ä¿å­˜å‰ä¸€å¤©çš„è³‡æ–™
                    if (currentDay) {
                        html += generateDayRow(currentDay, currentMeals, totalCalories);
                    }
                    // é–‹å§‹æ–°çš„ä¸€å¤©
                    currentDay = dayMatch[1].replace('å‘¨', 'é€±');
                    currentMeals = { 'æ—©é¤': '', 'åˆé¤': '', 'æ™šé¤': '' };
                    
                    // æª¢æŸ¥ç¸½è¨ˆå¡è·¯é‡Œ
                    const calorieMatch = line.match(/(\d+)[å¡åƒ]/);
                    totalCalories = calorieMatch ? calorieMatch[1] : '';
                    return;
                }
                
                // æª¢æŸ¥æ˜¯å¦æ˜¯é¤æ¬¡è¡Œ
                meals.forEach(meal => {
                    const mealPattern = new RegExp(`ğŸ½ï¸?\\s*${meal}[ï¼š:]\\s*(.+)`);
                    const mealMatch = line.match(mealPattern);
                    if (mealMatch) {
                        let foodContent = mealMatch[1];
                        // ç§»é™¤ç‡Ÿé¤Šè³‡è¨Šæ‹¬è™Ÿ
                        foodContent = foodContent.replace(/\([^)]*\)/g, '').replace(/ï¼ˆ[^ï¼‰]*ï¼‰/g, '').trim();
                        currentMeals[meal] = foodContent;
                    }
                });
            });
            
            // è™•ç†æœ€å¾Œä¸€å¤©
            if (currentDay) {
                html += generateDayRow(currentDay, currentMeals, totalCalories);
            }
            
            // å¦‚æœæ²’æœ‰æ‰¾åˆ°ä»»ä½•æ—¥æœŸï¼Œå‰µå»ºä¸€å€‹åŸºæœ¬è¡¨æ ¼
            if (!currentDay) {
                console.log('âš ï¸ æœªæ‰¾åˆ°æ—¥æœŸæ ¼å¼ï¼Œå‰µå»ºåŸºæœ¬è¡¨æ ¼');
                html += `<tr>`;
                html += `<td class="day-column">é€±ä¸€</td>`;
                html += `<td><div class="meal-content"><div class="meal-foods">è«‹é‡æ–°ç”Ÿæˆé£Ÿè­œ</div></div></td>`;
                html += `<td><div class="meal-content"><div class="meal-foods">è«‹é‡æ–°ç”Ÿæˆé£Ÿè­œ</div></div></td>`;
                html += `<td><div class="meal-content"><div class="meal-foods">è«‹é‡æ–°ç”Ÿæˆé£Ÿè­œ</div></div></td>`;
                html += `</tr>`;
            }
            
            html += `</tbody></table>`;
            
            console.log('âœ… å¼·åˆ¶è¡¨æ ¼ç”Ÿæˆå®Œæˆ');
            return html;
        }
        
        // ç”Ÿæˆå–®æ—¥è¡¨æ ¼è¡Œ
        function generateDayRow(day, meals, calories) {
            let html = `<tr>`;
            html += `<td class="day-column">${day}</td>`;
            
            ['æ—©é¤', 'åˆé¤', 'æ™šé¤'].forEach(mealName => {
                const mealContent = meals[mealName] || 'æš«ç„¡å®‰æ’';
                html += `
                    <td>
                        <div class="meal-content">
                            <div class="meal-foods">${mealContent}</div>
                        </div>
                    </td>
                `;
            });
            
            html += `</tr>`;
            
            // æ·»åŠ å¡è·¯é‡Œç¸½è¨ˆè¡Œ
            if (calories) {
                html += `<tr class="calories-row">`;
                html += `<td><strong>${day}ç¸½è¨ˆ</strong></td>`;
                html += `<td colspan="3"><strong>ç´„${calories}å¡è·¯é‡Œ</strong></td>`;
                html += `</tr>`;
            }
            
            return html;
        }

        // å‚™ç”¨çš„ç°¡å–®æ–‡å­—å±•ç¤ºå‡½æ•¸
        function generateSimpleMenuDisplay(text) {
            console.log('ğŸ“„ ä½¿ç”¨ç°¡å–®æ–‡å­—å±•ç¤ºæ¨¡å¼');
            
            if (!text || text.trim().length === 0) {
                return '<div class="empty-menu-table">âŒ ç„¡æ³•ç”Ÿæˆé£Ÿè­œï¼Œè«‹é‡æ–°å˜—è©¦</div>';
            }
            
            // ç°¡å–®æ ¼å¼åŒ–æ–‡å­—
            let formattedText = text
                .replace(/\n/g, '<br>')  // æ›è¡Œè½‰æ›
                .replace(/(é€±[ä¸€äºŒä¸‰å››äº”å…­æ—¥]|æ˜ŸæœŸ[ä¸€äºŒä¸‰å››äº”å…­æ—¥])/g, '<h3 style="color: #667eea; margin: 20px 0 10px 0;">ğŸ“… $1</h3>')  // æ—¥æœŸæ¨™é¡Œ
                .replace(/(æ—©é¤|åˆé¤|æ™šé¤)/g, '<strong style="color: #764ba2;">ğŸ½ï¸ $1</strong>')  // é¤æ¬¡åŠ ç²—
                .replace(/(\d+[å¡åƒ][è·¯é‡Œ]?)/g, '<span style="background: #f093fb; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.9rem;">$1</span>');  // å¡è·¯é‡Œé«˜äº®
            
            return `
                <div style="padding: 20px; background: white; border-radius: 12px; line-height: 1.8;">
                    <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                        <h3 style="margin: 0; color: white;">ğŸ½ï¸ AIç”Ÿæˆçš„ä¸€é€±é£Ÿè­œ</h3>
                        <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 0.9rem;">ä»¥ä¸‹æ˜¯æ ¹æ“šæ‚¨çš„åå¥½å®¢è£½åŒ–çš„é£Ÿè­œå»ºè­°</p>
                    </div>
                    <div style="font-size: 0.95rem; color: #333;">
                        ${formattedText}
                    </div>
                </div>
            `;
        }

        // ç¡®è®¤åˆ é™¤é£Ÿè°±
        function confirmClearMenu() {
            pageLog('ğŸ—‘ï¸ [DELETE] é¡¯ç¤ºåˆªé™¤ç¢ºèªå°è©±æ¡†');
            
            // åˆ›å»ºç¡®è®¤å¯¹è¯æ¡†
            const confirmDiv = document.createElement('div');
            confirmDiv.id = 'menu-confirm-dialog'; // æ·»åŠ IDä»¥ä¾¿æ–¼è­˜åˆ¥
            confirmDiv.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            confirmDiv.innerHTML = `
                <div style="
                    background: white;
                    padding: 30px;
                    border-radius: 15px;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                    text-align: center;
                    max-width: 400px;
                    margin: 20px;
                ">
                    <div style="font-size: 24px; margin-bottom: 15px;">ğŸ—‘ï¸</div>
                    <h3 style="color: #333; margin-bottom: 15px;">ç¢ºèªåˆªé™¤é£Ÿè­œ</h3>
                    <p style="color: #666; margin-bottom: 25px; line-height: 1.5;">
                        æ‚¨ç¢ºå®šè¦åˆªé™¤ç›®å‰çš„ä¸€é€±é£Ÿè­œå—ï¼Ÿ<br>
                        åˆªé™¤å¾Œå¯ä»¥é‡æ–°ç”Ÿæˆæ–°çš„é£Ÿè­œè¨ˆç•«ã€‚
                    </p>
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button onclick="confirmDeleteMenu()" 
                                style="background: #ff6b6b; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            ç¢ºèªåˆªé™¤
                        </button>
                        <button onclick="cancelDeleteMenu()" 
                                style="background: #f8f9fa; color: #333; border: 1px solid #e1e5e9; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            å–æ¶ˆ
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(confirmDiv);
        }
        
        // ç¢ºèªåˆªé™¤é£Ÿè­œ
        function confirmDeleteMenu() {
            pageLog('âœ… [DELETE] ç”¨æˆ¶ç¢ºèªåˆªé™¤ï¼ŒåŸ·è¡Œåˆªé™¤æ“ä½œ');
            actualClearMenu();
            cancelDeleteMenu(); // é—œé–‰å°è©±æ¡†
        }
        
        // å–æ¶ˆåˆªé™¤é£Ÿè­œ  
        function cancelDeleteMenu() {
            pageLog('âŒ [DELETE] ç”¨æˆ¶å–æ¶ˆåˆªé™¤ï¼Œé—œé–‰å°è©±æ¡†');
            const dialog = document.getElementById('menu-confirm-dialog');
            if (dialog) {
                document.body.removeChild(dialog);
            }
        }

        // å®é™…åˆ é™¤é£Ÿè°±
        function actualClearMenu() {
            pageLog('ğŸ”„ [DELETE] é–‹å§‹åŸ·è¡Œå¯¦éš›åˆªé™¤æ“ä½œ');
            
            const weeklyMenuDiv = document.getElementById('weekly-menu-table');
            if (!weeklyMenuDiv) {
                pageLog('âŒ [DELETE] æ‰¾ä¸åˆ°é£Ÿè­œè¡¨æ ¼å…ƒç´ ');
                return;
            }
            
            // æ¸…ç©ºé£Ÿè­œé¡¯ç¤ºå€åŸŸ
            weeklyMenuDiv.innerHTML = `
                <div class="empty-menu-table">
                    ğŸ½ï¸ è¨­å®šæ‚¨çš„é£²é£Ÿåå¥½ï¼Œé–‹å§‹ç”Ÿæˆå°ˆå±¬é£Ÿè­œ
                </div>
            `;
            pageLog('âœ… [DELETE] é£Ÿè­œé¡¯ç¤ºå€åŸŸå·²æ¸…ç©º');
            
            // æ¸…é™¤æœ¬åœ°å­˜å‚¨
            localStorage.removeItem('weeklyMenu');
            weeklyMenu = null;
            pageLog('âœ… [DELETE] æœ¬åœ°å­˜å„²å·²æ¸…é™¤');
            
            // é‡ç½®æŒ‰é’®çŠ¶æ€
            resetMenuButtons();
            pageLog('âœ… [DELETE] æŒ‰éˆ•ç‹€æ…‹å·²é‡ç½®');
            
            // ç§»é™¤é”å®šæ ·å¼
            weeklyMenuDiv.classList.remove('menu-locked');
            pageLog('âœ… [DELETE] é–å®šæ¨£å¼å·²ç§»é™¤');
            
            pageLog('ğŸ‰ [DELETE] é£Ÿè­œåˆªé™¤å®Œæˆï¼å¯ä»¥é‡æ–°ç”Ÿæˆæ–°é£Ÿè­œ');
        }

        // é‡ç½®èœå•æŒ‰é’®çŠ¶æ€
        function resetMenuButtons() {
            const generateBtn = document.getElementById('generate-menu-btn');
            const clearBtn = document.getElementById('clear-menu-btn');
            
            if (generateBtn) {
                generateBtn.style.display = 'inline-block';
                generateBtn.disabled = false;
                generateBtn.textContent = 'ğŸ¯ ç”Ÿæˆå°ˆå±¬ä¸€é€±é£Ÿè­œ';
                generateBtn.style.opacity = '1';
                pageLog('ğŸ”„ [RESET] ç”ŸæˆæŒ‰éˆ•å·²é‡ç½®');
            }
            
            if (clearBtn) {
                clearBtn.style.display = 'none';
                pageLog('ğŸ”„ [RESET] æ¸…é™¤æŒ‰éˆ•å·²éš±è—');
            }
        }



        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®
            const savedProfile = localStorage.getItem('userProfile');
            const savedGoals = localStorage.getItem('nutritionGoals');
            const savedFood = localStorage.getItem('todayFood');
            const savedMenu = localStorage.getItem('weeklyMenu');
            
            if (savedProfile) {
                userProfile = JSON.parse(savedProfile);
                // å¡«å……è¡¨å•
                document.getElementById('age').value = userProfile.age;
                document.getElementById('height').value = userProfile.height;
                document.getElementById('weight').value = userProfile.weight;
                document.getElementById('gender').value = userProfile.gender;
                document.getElementById('activity').value = userProfile.activity;
                
                // å¡«å……æ–°æ·»åŠ çš„å¥åº·ä¿¡æ¯å­—æ®µ
                if (userProfile.medicalConditions) {
                    document.getElementById('medical-conditions').value = userProfile.medicalConditions;
                }
                if (userProfile.allergies) {
                    document.getElementById('allergies').value = userProfile.allergies;
                }
            }
            
            if (savedGoals) {
                nutritionGoals = JSON.parse(savedGoals);
            }
            
            if (savedFood) {
                todayFood = JSON.parse(savedFood);
                updateFoodLog();
            }
            
            // æ¢å¤ä¸€å‘¨é£Ÿè°±æ•°æ®
            if (savedMenu) {
                weeklyMenu = JSON.parse(savedMenu);
                // æ£€æŸ¥é£Ÿè°±æ˜¯å¦è¿˜æ–°é²œï¼ˆ7å¤©å†…ç”Ÿæˆçš„ï¼‰
                const daysSinceGenerated = (Date.now() - weeklyMenu.timestamp) / (1000 * 60 * 60 * 24);
                if (daysSinceGenerated <= 7) {
                    // æ¢å¤é£Ÿè°±åå¥½è®¾ç½®
                    if (weeklyMenu.preferences) {
                        document.getElementById('diet-goal').value = weeklyMenu.preferences.dietGoal || '';
                        document.getElementById('cuisine-preference').value = weeklyMenu.preferences.cuisinePreference || 'balanced';
                        document.getElementById('dislike-foods').value = weeklyMenu.preferences.dislikeFoods || '';
                        document.getElementById('budget-range').value = weeklyMenu.preferences.budgetRange || 'medium';
                    }
                    // æ˜¾ç¤ºä¿å­˜çš„é£Ÿè°±è¡¨æ ¼
                    const formattedTable = parseWeeklyMenuToTable(weeklyMenu.content);
                    document.getElementById('weekly-menu-table').innerHTML = formattedTable;
                    
                    // è®¾ç½®æŒ‰é’®çŠ¶æ€ä¸ºå·²ç”Ÿæˆ
                    document.getElementById('generate-menu-btn').style.display = 'none';
                    document.getElementById('clear-menu-btn').style.display = 'inline-block';
                    document.getElementById('weekly-menu-table').classList.add('menu-locked');
                } else {
                    // é£Ÿè°±å¤ªæ—§ï¼Œæ¸…é™¤å¹¶æ˜¾ç¤ºé»˜è®¤çŠ¶æ€
                    localStorage.removeItem('weeklyMenu');
                    weeklyMenu = null;
                    document.getElementById('weekly-menu-table').innerHTML = `
                        <div class="empty-menu-table">
                            ğŸ½ï¸ è®¾ç½®æ‚¨çš„é¥®é£Ÿåå¥½ï¼Œå¼€å§‹ç”Ÿæˆä¸“å±é£Ÿè°±
                        </div>
                    `;
                    resetMenuButtons();
                }
            } else {
                // åˆå§‹åŒ–ç©ºç™½é£Ÿè­œé¡¯ç¤º
                document.getElementById('weekly-menu-table').innerHTML = `
                    <div class="empty-menu-table">
                        ğŸ½ï¸ è¨­å®šæ‚¨çš„é£²é£Ÿåå¥½ï¼Œé–‹å§‹ç”Ÿæˆå°ˆå±¬é£Ÿè­œ
                    </div>
                `;
                resetMenuButtons();
            }
            
            updateNutritionDisplay();
            if (Object.keys(userProfile).length > 0) {
                updateRecommendations();
                updateHealthAlerts();
            }

            // 3ç§’åæ˜¾ç¤ºæ¬¢è¿æ°”æ³¡
            setTimeout(() => {
                document.getElementById('assistantBubble').style.display = 'block';
                bubbleVisible = true;
                setTimeout(() => {
                    document.getElementById('assistantBubble').style.display = 'none';
                    bubbleVisible = false;
                }, 4000);
            }, 2000);
        };
    </script>
</body>
</html> 